# ğŸ“– 4ì¥: ìœ ì—°ì„±ê³¼ ë³µì¡ì„± ì‚¬ì´ì˜ ê· í˜•

## 4.1 íƒ„íƒ„í•˜ì§€ë§Œ í™•ì¥ì„±ì€ ë–¨ì–´ì§€ëŠ” API

* **ë‚´ìš©**

    * ìƒˆë¡œìš´ ì»´í¬ë„ŒíŠ¸(`HttpClientExecution`) ì„¤ê³„: ìš”ì²­ ì„±ê³µ/ì‹¤íŒ¨/ì¬ì‹œë„ ë©”íŠ¸ë¦­ ê¸°ë¡.
    * ì´ˆê¸° ì„¤ê³„ëŠ” ë‹¨ìˆœí•˜ê³  ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰¬ì›€. ê·¸ëŸ¬ë‚˜ íŠ¹ì • ë©”íŠ¸ë¦­ ë¼ì´ë¸ŒëŸ¬ë¦¬(`Dropwizard Metrics`)ì— ê°•í•˜ê²Œ ê²°í•©.
    * í™•ì¥ ì§€ì ì´ ë¶€ì¡±í•˜ì—¬ ë‹¤ë¥¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì“°ê³  ì‹¶ì€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì œì•½ ë°œìƒ.
    * ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¡œ ì„±ê³µ, ì‹¤íŒ¨, ì¬ì‹œë„ ì¼€ì´ìŠ¤ ê²€ì¦.

* **ì œ ìƒê°**
  ë‹¨ìˆœ êµ¬í˜„ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê±´ í˜„ëª…í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì¡°ì§ ë‹¨ìœ„ ì¬ì‚¬ìš© ì»´í¬ë„ŒíŠ¸ë¼ë©´ â€œì²˜ìŒë¶€í„° í™•ì¥ ê°€ëŠ¥ì„±â€ì„ ì˜ì‹í•˜ì§€ ì•Šìœ¼ë©´ ê¸ˆë°© ë¦¬íŒ©í„°ë§ ì§€ì˜¥ì— ë¹ ì§€ê¸° ì‰½ìŠµë‹ˆë‹¤.

---

## 4.2 ë©”íŠ¸ë¦­ ì¶”ìƒí™”

* **ë‚´ìš©**

    * `MetricsProvider` ì¸í„°í˜ì´ìŠ¤ ë„ì… â†’ ë©”íŠ¸ë¦­ ë¡œì§ ì¶”ìƒí™”.
    * ê¸°ë³¸ êµ¬í˜„(`DefaultMetricsProvider`) ì œê³µ.
    * ë³µì¡ì„±ì€ ë‚´ë¶€ì—ì„œ ì¤„ì—ˆì§€ë§Œ í´ë¼ì´ì–¸íŠ¸ê°€ êµ¬í˜„ ë¶€ë‹´ì„ ë– ì•ˆê²Œ ë¨.
    * **íŠ¸ë ˆì´ë“œì˜¤í”„**: ìœ ì—°ì„± ì¦ê°€ â†” í´ë¼ì´ì–¸íŠ¸ ë¶€ë‹´ ì¦ê°€.

* **ì œ ìƒê°**
  API ì„¤ê³„ì—ì„œ í”íˆ ë“±ì¥í•˜ëŠ” **â€œë‚´ë¶€ ë‹¨ìˆœí™” vs ì™¸ë¶€ ë³µì¡í™”â€** ë¬¸ì œ. ì¢‹ì€ íƒ€í˜‘ì€ â€œì¶”ìƒí™” + ê¸°ë³¸ êµ¬í˜„ ì œê³µâ€ì´ë¼ê³  ìƒê°í•©ë‹ˆë‹¤.

---

## 4.3 í›…(Hook) API

* **ë‚´ìš©**

    * í´ë¼ì´ì–¸íŠ¸ê°€ íŠ¹ì • ì‹œì ì— ìì‹ ë§Œì˜ ì½”ë“œë¥¼ ì‚½ì… ê°€ëŠ¥.
    * ì¥ì : ë¯¸ë˜ ìš”êµ¬ì‚¬í•­ì„ ì˜ˆì¸¡í•˜ì§€ ì•Šê³ ë„ í™•ì¥ì„± í™•ë³´.
    * ë‹¨ì :

        * ì˜ˆì™¸ ì²˜ë¦¬ í•„ìš” (í´ë¼ì´ì–¸íŠ¸ ì½”ë“œê°€ ë˜ì§€ëŠ” ëŸ°íƒ€ì„ ì˜ˆì™¸ ë°©ì–´).
        * ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ (ì°¨ë‹¨/IO ì‘ì—…ìœ¼ë¡œ ì¸í•œ ì§€ì—°, ë°ë“œë½ ìœ„í—˜).
        * í•´ê²°ì±…: í›… ì‹¤í–‰ì„ ìŠ¤ë ˆë“œí’€ë¡œ ë³‘ë ¬ ì²˜ë¦¬.

* **ì œ ìƒê°**
  â€œí™•ì¥ì„±ì€ ê³µì§œê°€ ì•„ë‹ˆë‹¤.â€ ì„±ëŠ¥ ì €í•˜ + ìš´ì˜ ë¦¬ìŠ¤í¬ë¥¼ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— í›…ì€ ê¼­ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ìµœì†Œí™”í•´ì•¼ í•œë‹¤ê³  ë´…ë‹ˆë‹¤.

---

## 4.4 ë¦¬ìŠ¤ë„ˆ(Listener) API

* **ë‚´ìš©**

    * ì˜µì €ë²„ íŒ¨í„´ í™œìš©: íŠ¹ì • ì´ë²¤íŠ¸(ì˜ˆ: ì¬ì‹œë„ ìƒíƒœ) ë°œìƒ ì‹œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì•Œë¦¼.
    * ë¹„ë™ê¸° ì²˜ë¦¬ë¼ ì„±ëŠ¥ìƒ ì•ˆì „.
    * ë‹¨ì :

        * ìƒíƒœ ë¶ˆë³€ì„± ë¬¸ì œ (í´ë¼ì´ì–¸íŠ¸ê°€ ì „ë‹¬ë°›ì€ ìƒíƒœ ë³€ê²½ ê°€ëŠ¥).
        * í•´ê²°ì±…: ë°©ì–´ì  ë³µì‚¬ ë˜ëŠ” ë¶ˆë³€ ê°ì²´(`ImmutableList`) í™œìš©.
        * íŠ¸ë˜í”½ ê¸‰ì¦ ì‹œ ë¦¬ìŠ¤ë„ˆ ê³¼ë¶€í•˜ â†’ ì—­ì••(Backpressure) í•„ìš”.

* **ì œ ìƒê°**
  ë¦¬ìŠ¤ë„ˆëŠ” í™•ì¥ì„±ì— ìœ ë¦¬í•˜ì§€ë§Œ, â€œìƒíƒœ ì „ë‹¬â€ì´ í•­ìƒ ë¯¼ê° í¬ì¸íŠ¸. ì €ëŠ” ë¦¬ìŠ¤ë„ˆ ì„¤ê³„ ì‹œ ë¬´ì¡°ê±´ **ë¶ˆë³€ ë°ì´í„° ì „ë‹¬ ì›ì¹™**ì„ ì§€í‚¤ëŠ” í¸ì…ë‹ˆë‹¤.

---

## 4.5 ì¢…í•© (ìœ ì—°ì„± vs ë³µì¡ì„±)

* **ë‚´ìš©**

    * ëª¨ë“  ìƒˆë¡œìš´ ê¸°ëŠ¥ì€ ë³µì¡ì„±ì„ ì¦ê°€ì‹œí‚¨ë‹¤.
    * ì¶”ìƒí™”: ë‚´ë¶€ ë³µì¡ì„± ê°ì†Œ, ì™¸ë¶€ ë³µì¡ì„± ì¦ê°€.
    * í›…/ë¦¬ìŠ¤ë„ˆ: ê°•ë ¥í•œ ìœ ì—°ì„±, í•˜ì§€ë§Œ ìƒíƒœ ê´€ë¦¬Â·ì„±ëŠ¥Â·ì˜ˆì™¸ ì²˜ë¦¬ ë¹„ìš© ë°œìƒ.
    * ì„¤ê³„ ì‹œ **ìœ ì—°ì„±ê³¼ ë³µì¡ì„± ì‚¬ì´ì˜ ê· í˜•**ì„ ë°˜ë“œì‹œ ê³ ë ¤í•´ì•¼ í•œë‹¤.

* **ì œ ìƒê°**
  ìœ ì—°ì„±ì€ ì¡°ì§ ì„±ìˆ™ë„ì™€ **ìš´ì˜ ëŠ¥ë ¥ì— ë§ê²Œ** ê°€ì ¸ê°€ì•¼ í•©ë‹ˆë‹¤. `ìŠ¤íƒ€íŠ¸ì—… ë‹¨ê³„ë¼ë©´ ë‹¨ìˆœí•œ ì¶”ìƒí™”`, `ëŒ€ê·œëª¨ í”Œë«í¼ì´ë¼ë©´ í›…/ë¦¬ìŠ¤ë„ˆ`ê¹Œì§€ ê³ ë ¤ê°€ í•©ë¦¬ì ì…ë‹ˆë‹¤.

---

# ğŸ“ ìš”ì•½ (ì••ì¶•)

* ë‹¨ìˆœ â†’ ì¶”ìƒí™” â†’ í›… â†’ ë¦¬ìŠ¤ë„ˆ ìˆœìœ¼ë¡œ ê°ˆìˆ˜ë¡ **ìœ ì—°ì„± â†‘ / ë³µì¡ì„± â†‘**.
* ì¢‹ì€ íƒ€í˜‘: ì¶”ìƒí™” + ê¸°ë³¸ êµ¬í˜„ ì œê³µ.
* í›…: í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ ì‚½ì… ê°€ëŠ¥í•˜ì§€ë§Œ ì„±ëŠ¥Â·ì•ˆì •ì„± ë¹„ìš© ìˆìŒ.
* ë¦¬ìŠ¤ë„ˆ: ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì•Œë¦¼ êµ¬ì¡°, ë¶ˆë³€ ë°ì´í„° ì „íŒŒ í•„ìˆ˜.
* í•µì‹¬ êµí›ˆ: **ìœ ì—°ì„±ì€ ê³µì§œê°€ ì•„ë‹ˆë©°, ë³µì¡ì„±ê³¼ í•­ìƒ íŠ¸ë ˆì´ë“œì˜¤í”„ ê´€ê³„**.

---

# ğŸ’» Kotlin ì˜ˆì œ ì½”ë“œ (ë„ë©”ì¸: ê²°ì œ ì¬ì‹œë„)

### As-Is (ë‹¨ìˆœ êµ¬í˜„)

```kotlin
class PaymentService(
    private val metrics: PaymentMetrics,
    private val maxRetries: Int
) {
    fun pay(orderId: String): Boolean {
        repeat(maxRetries + 1) { attempt ->
            try {
                val result = callExternalPayment(orderId)
                if (result) {
                    metrics.success()
                    return true
                } else {
                    metrics.failure()
                }
            } catch (ex: Exception) {
                metrics.failure()
            }
            if (attempt < maxRetries) metrics.retry()
        }
        return false
    }

    private fun callExternalPayment(orderId: String): Boolean {
        // ì‹¤ì œ ê²°ì œ API í˜¸ì¶œ (ê°„ë‹¨íˆ true/false ë°˜í™˜í•œë‹¤ê³  ê°€ì •)
        return orderId.length % 2 == 0
    }
}

interface PaymentMetrics {
    fun success()
    fun failure()
    fun retry()
}

class DefaultPaymentMetrics : PaymentMetrics {
    override fun success() = println("Success +1")
    override fun failure() = println("Failure +1")
    override fun retry() = println("Retry +1")
}
```

---

### To-Be (ë¦¬ìŠ¤ë„ˆ í™•ì¥ ì ìš©)

```kotlin
/**
 * ì¬ì‹œë„ ê³¼ì •ì—ì„œì˜ ìƒíƒœ ìŠ¤ëƒ…ìƒ·.
 *
 * @property attempt 1ë¶€í„° ì‹œì‘í•˜ëŠ” ì¬ì‹œë„ íšŸìˆ˜ (ì˜ˆ: ì²« ì¬ì‹œë„=1)
 */
data class RetryStatus(val attempt: Int)

/**
 * ê²°ì œ ì¬ì‹œë„ ì´ë²¤íŠ¸ë¥¼ ë¹„ë™ê¸°/ì˜µì €ë²„ì²˜ëŸ¼ ë°›ì•„ ì²˜ë¦¬í•˜ëŠ” ë¦¬ìŠ¤ë„ˆ.
 * - ì„¤ê³„ ì˜ë„: ë‚´ë¶€ ë¡œì§ì„ ì§ì ‘ ìˆ˜ì •í•˜ì§€ ì•Šê³ ë„ ì™¸ë¶€ì—ì„œ í™•ì¥(ë¡œê¹…/ëª¨ë‹ˆí„°ë§ ë“±) ê°€ëŠ¥
 */
interface RetryListener {
    /**
     * ì¬ì‹œë„ ìƒíƒœë“¤ì˜ ìŠ¤ëƒ…ìƒ·ì„ í†µì§€ë°›ëŠ”ë‹¤.
     * - ë¶ˆë³€ ì „ë‹¬ì„ ìœ„í•´ í˜¸ì¶œ ì¸¡ì—ì„œ snapshot(toList())ì„ ë§Œë“¤ì–´ ì¤€ë‹¤.
     */
    fun onRetry(statuses: List<RetryStatus>)
}

/**
 * ê²°ì œ ì²˜ë¦¬ ì„œë¹„ìŠ¤(í™•ì¥í˜•).
 *
 * ì„¤ê³„ í¬ì¸íŠ¸
 * 1) Metrics ì¶”ìƒí™” ì£¼ì…: ë‚´ë¶€ëŠ” íŠ¹ì • ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ê²°í•©í•˜ì§€ ì•ŠìŒ.
 * 2) Listener í™•ì¥ ì§€ì : ì¬ì‹œë„ ì´ë²¤íŠ¸ë¥¼ ì™¸ë¶€ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸(ìƒíƒœëŠ” ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì „ë‹¬).
 * 3) ìƒíƒœ ë¶ˆë³€ì„±: listenersì— ì „ë‹¬í•˜ëŠ” ì»¬ë ‰ì…˜ì€ ë§¤ í˜¸ì¶œ ì‹œ snapshotì„ ë„˜ê²¨ side-effect ì°¨ë‹¨.
 *
 * @param metrics   ì„±ê³µ/ì‹¤íŒ¨/ì¬ì‹œë„ ì¹´ìš´íŒ…ì„ ë‹´ë‹¹í•˜ëŠ” ì¶”ìƒí™”ëœ ë©”íŠ¸ë¦­ ê¸°ë¡ì
 * @param maxRetries ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ (ì˜ˆ: 2ë©´ ì´ ì‹œë„ íšŸìˆ˜ëŠ” 1+2=3íšŒ)
 * @param listeners ì¬ì‹œë„ ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•˜ëŠ” ë¦¬ìŠ¤ë„ˆ ëª©ë¡(ê¸°ë³¸ì€ ë¹ˆ ëª©ë¡)
 */
class PaymentServiceV2(
    private val metrics: PaymentMetrics,
    private val maxRetries: Int,
    private val listeners: MutableList<RetryListener> = mutableListOf()
) {

    /**
     * ë¦¬ìŠ¤ë„ˆ ë“±ë¡.
     * - ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì´ë¼ë©´ CopyOnWriteArrayList ë“±ìœ¼ë¡œ êµì²´ ê³ ë ¤.
     */
    fun registerListener(listener: RetryListener) {
        listeners.add(listener)
    }

    /**
     * ê²°ì œ ì‹œë„ ì§„ì…ì .
     *
     * íë¦„
     * - (ì„±ê³µ) ì¦‰ì‹œ success() ê¸°ë¡ í›„, ì§€ê¸ˆê¹Œì§€ì˜ ì¬ì‹œë„ ìƒíƒœ ìŠ¤ëƒ…ìƒ·ì„ ë¦¬ìŠ¤ë„ˆì— í†µì§€í•˜ê³  true ë°˜í™˜
     * - (ì‹¤íŒ¨) failure() ê¸°ë¡ â†’ (ì¬ì‹œë„ ê°€ëŠ¥) retry() ë° ìƒíƒœ ì¶•ì  â†’ ë°˜ë³µ
     * - (ì „ë¶€ ì‹¤íŒ¨) ë§ˆì§€ë§‰ì— ìµœì¢… ìŠ¤ëƒ…ìƒ·ì„ ë¦¬ìŠ¤ë„ˆì— í†µì§€í•˜ê³  false ë°˜í™˜
     *
     * ì£¼ì˜
     * - ë°˜ë³µë¬¸ì€ 0..maxRetries(í¬í•¨)ë¡œ ì´ ì‹œë„ íšŸìˆ˜ = ì´ˆê¸° 1íšŒ + ì¬ì‹œë„ NíšŒ
     * - ë¦¬ìŠ¤ë„ˆì—ëŠ” ë§¤ë²ˆ ìƒˆë¡œìš´ List ìŠ¤ëƒ…ìƒ·(toList())ì„ ë„˜ê²¨ ì™¸ë¶€ ë³€ê²½ìœ¼ë¡œë¶€í„° ë‚´ë¶€ ìƒíƒœ ë³´í˜¸
     */
    fun pay(orderId: String): Boolean {
        val statuses = mutableListOf<RetryStatus>() // ëˆ„ì  ì¬ì‹œë„ ìƒíƒœ(ì‹œë„í•  ë•Œë§ˆë‹¤ ì¶”ê°€)

        repeat(maxRetries + 1) { attempt ->
            try {
                val result = callExternalPayment(orderId)

                if (result) {
                    // 1) ì„±ê³µ: ì„±ê³µ ë©”íŠ¸ë¦­ ê¸°ë¡ í›„, í˜„ì¬ê¹Œì§€ì˜ ì¬ì‹œë„ ìƒíƒœ ìŠ¤ëƒ…ìƒ·ì„ í†µì§€í•˜ê³  ì¢…ë£Œ
                    metrics.success()
                    notifyListeners(statuses.toList()) // ë¶ˆë³€ ìŠ¤ëƒ…ìƒ· ì „ë‹¬(ë°©ì–´ì  ë³µì‚¬)
                    return true
                } else {
                    // 2) ì™¸ë¶€ í˜¸ì¶œì€ ì„±ê³µì ìœ¼ë¡œ ëë‚¬ì§€ë§Œ ë¹„ì¦ˆë‹ˆìŠ¤ ì‹¤íŒ¨ë¡œ ê°„ì£¼ë˜ëŠ” ê²½ìš°
                    metrics.failure()
                }
            } catch (ex: Exception) {
                // 3) ë„¤íŠ¸ì›Œí¬/ì˜ˆì™¸ ë“± ê¸°ìˆ ì  ì‹¤íŒ¨
                metrics.failure()
            }

            // 4) ì•„ì§ ì¬ì‹œë„ ê¸°íšŒê°€ ë‚¨ì•˜ìœ¼ë©´ ì¬ì‹œë„ ë©”íŠ¸ë¦­ ê¸°ë¡ + ìƒíƒœ ì¶•ì 
            if (attempt < maxRetries) {
                metrics.retry()
                statuses.add(RetryStatus(attempt = attempt + 1)) // attemptëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1
            }
        }

        // 5) ëª¨ë‘ ì‹¤íŒ¨: ëˆ„ì  ìƒíƒœë¥¼ ë§ˆì§€ë§‰ìœ¼ë¡œ í†µì§€ í›„ false ë°˜í™˜
        notifyListeners(statuses.toList())
        return false
    }

    /**
     * ë¦¬ìŠ¤ë„ˆë“¤ì—ê²Œ ì¬ì‹œë„ ìƒíƒœ ìŠ¤ëƒ…ìƒ·ì„ ë¸Œë¡œë“œìºìŠ¤íŠ¸.
     * - ListëŠ” ì½ê¸° ì „ìš© ë·°ì§€ë§Œ, ì™¸ë¶€ ë³€ê²½ì— ëŒ€ë¹„í•´ í•­ìƒ toList()ë¡œ ìƒˆ ë¦¬ìŠ¤íŠ¸ë¥¼ ë„˜ê¸´ë‹¤.
     * - ê³ ë¶€í•˜/ê³ ë¹ˆë„ë¼ë©´ í/ë°±í”„ë ˆì…”/ë¹„ë™ê¸° ë””ìŠ¤íŒ¨ì¹˜ ê³ ë ¤.
     */
    private fun notifyListeners(statuses: List<RetryStatus>) {
        // í•„ìš” ì‹œ try-catchë¡œ ê°œë³„ ë¦¬ìŠ¤ë„ˆ ì‹¤íŒ¨ ê²©ë¦¬ & ë¡œê¹… ê¶Œì¥
        listeners.forEach { it.onRetry(statuses) }
    }

    /**
     * ì‹¤ì œ ì™¸ë¶€ ê²°ì œ ì‹œìŠ¤í…œ í˜¸ì¶œ(ìƒ˜í”Œ).
     * - ì˜ˆì œì—ì„œëŠ” orderId ê¸¸ì´ì˜ ì§/í™€ë¡œ ì„±ê³µ/ì‹¤íŒ¨ë¥¼ í‰ë‚´ë‚¸ë‹¤.
     * - ì‹¤ì „ì—ì„œëŠ” íƒ€ì„ì•„ì›ƒ/ì¬ì‹œë„ ì •ì±…/ì—ëŸ¬ ë§¤í•‘ ë“±ì„ í•¨ê»˜ ë‹¤ë£¬ë‹¤.
     */
    private fun callExternalPayment(orderId: String): Boolean {
        return orderId.length % 2 == 0
    }
}

/**
 * ë©”íŠ¸ë¦­ ì¶”ìƒí™”.
 * - íŠ¹ì • ë¼ì´ë¸ŒëŸ¬ë¦¬(Dropwizard, Micrometer ë“±)ì— ëŒ€í•œ ê²°í•©ì„ ì œê±°í•˜ê¸° ìœ„í•œ í¬íŠ¸(Port)
 */
interface PaymentMetrics {
    fun success()
    fun failure()
    fun retry()
}

```

---

# âœ… Kotest í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ

```kotlin
import io.kotest.core.spec.style.StringSpec
import io.kotest.matchers.shouldBe

class PaymentServiceTest : StringSpec({

    "ì²« ì‹œë„ì— ì„±ê³µí•˜ë©´ ì¬ì‹œë„ ì—†ìŒ" {
        val metrics = TestMetrics()
        val service = PaymentService(metrics, maxRetries = 3)

        val result = service.pay("1234")

        result shouldBe true
        metrics.successCount shouldBe 1
        metrics.retryCount shouldBe 0
    }

    "ì‹¤íŒ¨ í›„ ì¬ì‹œë„ ì„±ê³µ ì‹œ ë¦¬ìŠ¤ë„ˆ í˜¸ì¶œ" {
        val metrics = TestMetrics()
        val service = PaymentServiceV2(metrics, maxRetries = 2)
        val retries = mutableListOf<RetryStatus>()

        service.registerListener(object : RetryListener {
            override fun onRetry(status: RetryStatus) {
                retries.add(status)
            }
        })

        val result = service.pay("123") // í™€ìˆ˜ â†’ ì²« ì‹¤íŒ¨, ë‘ ë²ˆì§¸ ì„±ê³µ

        result shouldBe true
        retries.size shouldBe 1
        retries.first().attempt shouldBe 1
    }
})

class TestMetrics : PaymentMetrics {
    var successCount = 0
    var failureCount = 0
    var retryCount = 0
    override fun success() { successCount++ }
    override fun failure() { failureCount++ }
    override fun retry() { retryCount++ }
}
```

---

# ğŸŒ ì°¸ê³  ìë£Œ

* [Dropwizard Metrics ê³µì‹ ë¬¸ì„œ](https://metrics.dropwizard.io/4.2.0) â€“ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë¼ì´ë¸ŒëŸ¬ë¦¬
* [Observer Pattern (GoF ë””ìì¸ íŒ¨í„´)](https://refactoring.guru/design-patterns/observer)
* [Hook vs Listener API ì„¤ê³„ ë¹„êµ](https://martinfowler.com/articles/injection.html)
