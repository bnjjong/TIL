# 3.1 ì˜ˆì™¸ì˜ ê³„ì¸µ êµ¬ì¡° â€” ë¬´ì—‡ì„ ì–´ë””ì„œ ì¡ì„ ê²ƒì¸ê°€

* ìë°”ì˜ ëª¨ë“  ì˜ˆì™¸ëŠ” `Throwable`ì„ ë£¨íŠ¸ë¡œ í•˜ë©°, í¬ê²Œ `Error`(ì¹˜ëª…ì , ë³´í†µ ì¡ì§€ ì•ŠìŒ)ì™€ `Exception`ìœ¼ë¡œ ë‚˜ë‰¨. `Exception`ì€ ë‹¤ì‹œ **Checked**(ì»´íŒŒì¼ëŸ¬ê°€ ì²˜ë¦¬ ê°•ì œ)ì™€ **Unchecked**(`RuntimeException` ê³„ì—´, ì„ íƒ ì²˜ë¦¬)ë¡œ êµ¬ë¶„. ì´ êµ¬ë¶„ì€ â€œí˜¸ì¶œìì—ê²Œ ë³µêµ¬ ê¸°íšŒë¥¼ ì¤„ ê²ƒì¸ê°€?â€ë¥¼ API ê³„ì•½ ì°¨ì›ì—ì„œ í‘œí˜„í•˜ëŠ” ì¥ì¹˜ë‹¤.
* **ì„¸ë¶„í™”ëœ catch** vs **ê´‘ì—­ catch**: ë” ë„“ì€ íƒ€ì…(ì˜ˆ: `IOException`)ìœ¼ë¡œ ì¡ìœ¼ë©´ ì½”ë“œê°€ ë‹¨ìˆœí•´ì§€ì§€ë§Œ, êµ¬ì²´ ì˜ˆì™¸ ì •ë³´(ì˜ˆ: `FileAlreadyExistsException`)ë¥¼ ìƒì–´ ë””ë²„ê¹…/ì²˜ì¹˜ê°€ ì–´ë ¤ì›Œì§ˆ ìˆ˜ ìˆë‹¤. í•„ìš” ì‹œ **ë©€í‹°-catch**( `catch (IOException | InterruptedException e)` )ë¡œ ì¤‘ë³µì„ ì¤„ì´ë˜, ì˜ë¯¸ ìˆëŠ” ì •ë³´ëŠ” ìœ ì§€í•œë‹¤.
* Unchecked ì˜ˆì™¸ëŠ” ì„ ì–¸ë„/ì²˜ë¦¬ë„ ê°•ì œê°€ ì•„ë‹ˆì–´ì„œ ì‰½ê²Œ `main`ê¹Œì§€ ì „íŒŒë¼ ì•±ì„ ì¤‘ë‹¨ì‹œí‚¬ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ â€œì •ë§ ë³µêµ¬ ë¶ˆê°€â€ì´ê±°ë‚˜ â€œê³„ì•½ ìœ„ë°˜(ì„ í–‰ì¡°ê±´ ìœ„ë°˜)â€ì„ ì‹ ì† ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©í•œë‹¤.

**ë„ì‹: ìë°” ì˜ˆì™¸ ê³„ì¸µ(ìš”ì•½)**

| ë£¨íŠ¸          | ë¶„ê¸°                            | ëŒ€í‘œ íƒ€ì…                                              | ì²˜ë¦¬ ê°€ì´ë“œ                         |
| ----------- | ----------------------------- | -------------------------------------------------- | ------------------------------ |
| `Throwable` | `Error`                       | `OutOfMemoryError` ë“±                               | ì¼ë°˜ì ìœ¼ë¡œ ì¡ì§€ ì•ŠìŒ                    |
| ã€ƒ           | `Exception`(Checked)          | `IOException`, `InterruptedException`              | í˜¸ì¶œì ë³µêµ¬ ì˜ë„ â†’ ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ì— ì„ ì–¸/ì²˜ë¦¬ ê°•ì œ |
| ã€ƒ           | `RuntimeException`(Unchecked) | `IllegalArgumentException`, `NullPointerException` | ì„ í–‰ì¡°ê±´ ìœ„ë°˜/í”„ë¡œê·¸ë˜ë° ì˜¤ë¥˜/ë³µêµ¬ ë¶ˆê°€ â†’ ì„ íƒ ì²˜ë¦¬ |

> âœï¸ ì§§ì€ ì²¨ì–¸: ë„ë©”ì¸ ê²½ê³„(public API)ì—ì„œëŠ” **ê°€ëŠ¥í•œ ì‹¤íŒ¨ë¥¼ â€œëª…ì‹œì ìœ¼ë¡œâ€ ë“œëŸ¬ë‚´ëŠ”** í¸ì´ í˜‘ì—…/ìœ ì§€ë³´ìˆ˜ì— ìœ ë¦¬í•©ë‹ˆë‹¤. ë‚´ë¶€(private) êµ¬í˜„ì€ ë¶ˆí•„ìš”í•œ ì¥í™©í•¨ì„ ì¤„ì´ë˜, ìƒìœ„ ê³„ì¸µì´ ë³µêµ¬ë¥¼ ì˜ë„í•˜ëŠ” ì§€ì ì´ë¼ë©´ **êµ¬ì²´ ì˜ˆì™¸ ì •ë³´ë¥¼ ìƒì§€ ì•Šê²Œ** ì„¤ê³„í•˜ëŠ” ê²Œ í¬ì¸íŠ¸.

---

# 3.2 ë‚´ê°€ ì†Œìœ í•œ ì½”ë“œ(API)ì—ì„œì˜ ìš°ìˆ˜ ì‚¬ë¡€

* **ê³µê°œ APIì—ì„œ Checked ì˜ˆì™¸ ì„ ì–¸**: í˜¸ì¶œìì—ê²Œ â€œë¬´ì—‡ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆëŠ”ì§€â€ë¥¼ ê³„ì•½ìœ¼ë¡œ ì•Œë ¤ì¤€ë‹¤. í•„ìš”í•˜ë©´ ë‚´ë¶€ì—ì„œ í•œ ë²ˆ ì¡ì•„ **Uncheckedë¡œ ê°ì‹¸ ì¬ì „íŒŒ**(wrap)í•´ í˜¸ì¶œì ë¶€ë‹´ì„ ë‚®ì¶œ ìˆ˜ë„ ìˆì§€ë§Œ, ì´ ë°©ì‹ì€ **ì˜ë¯¸ ìˆëŠ” ì‹¤íŒ¨ ì‹ í˜¸ë¥¼ ê°ì¶”ëŠ” ë¶€ì‘ìš©**ì´ ìˆìœ¼ë‹ˆ ë‚¨ìš© ê¸ˆì§€.
* **Unchecked ì˜ˆì™¸ì˜ ë¬¸ì„œí™” ì—­í• **: `IllegalArgumentException`, `IllegalStateException`ì„ ì‹œê·¸ë‹ˆì²˜ì— **ì„ ì–¸(throws ì—†ì´ íƒ€ì… ì–¸ê¸‰ ì°¨ì›)** í•´ ë‘ë©´, í˜¸ì¶œìëŠ” ì„ í–‰ì¡°ê±´/ìƒíƒœ ì œì•½ì„ IDE ìˆ˜ì¤€ì—ì„œ ì¦‰ì‹œ ì¸ì§€í•œë‹¤(ì‹¤ì œ ì¡ì„ ì˜ë¬´ëŠ” ì—†ìŒ). ê³¼ë„í•œ ì„ ì–¸ì€ ì¥í™©í•´ì§ˆ ìˆ˜ ìˆìœ¼ë‚˜, **public API** ì¼ë¶€ì— í•œì •ë˜ë¯€ë¡œ ê³¼í•˜ì§€ ì•Šê²Œ ìœ ì§€ ê°€ëŠ¥.
* ì–´ë–¤ ìœ í˜•(Checked/Unchecked)ì„ ì“¸ì§€ëŠ” **ì»¨í…ìŠ¤íŠ¸ íŠ¸ë ˆì´ë“œì˜¤í”„**ì˜ ë¬¸ì œ:

    * **ë‚´ë¶€ ëª¨ë“ˆ ê°„**(ì‘ì„±ì ë™ì¼): Uncheckedë¡œ ë‹¨ìˆœí™”í•´ë„ ë¦¬ìŠ¤í¬ê°€ ì‘ìŒ.
    * **ì™¸ë¶€/íƒ€íŒ€ í˜¸ì¶œ ê°€ëŠ¥ API**: Checkedë¡œ ëª…ì‹œì ìœ¼ë¡œ ì‹¤íŒ¨ë¥¼ ëª¨ë¸ë§í•˜ëŠ” í¸ì´ í˜¸ì¶œì ê²½í—˜/ì•ˆì „ì„± í–¥ìƒ.

> âœï¸ ì§§ì€ ì²¨ì–¸: â€œëª…ì‹œì„±ì´ëƒ, ë‹¨ìˆœì„±ì´ëƒâ€ì˜ ê· í˜• ì‹¸ì›€ì…ë‹ˆë‹¤. **ë„ë©”ì¸ ì‹¤íŒ¨ëŠ” íƒ€ì…/í”„ë¡œí† ì½œë¡œ, ì‹œìŠ¤í…œ ì‹¤íŒ¨ëŠ” ì˜ˆì™¸ë¡œ** êµ¬ë¶„í•˜ë©´ APIê°€ ê¹”ë”í•´ì§‘ë‹ˆë‹¤. ì˜ˆ: â€œì”ì•¡ ë¶€ì¡±â€ì€ ë„ë©”ì¸ ê²°ê³¼(`Result`)ë¡œ, â€œDB ì—°ê²° ëŠê¹€â€ì€ ì˜ˆì™¸ë¡œ.

---

# 3.3 í”¼í•´ì•¼ í•  ì•ˆí‹° íŒ¨í„´

1. **ì˜ˆì™¸ ì‚¼í‚¤ê¸°(swallow)**: `catch (Exception e) {}` í˜¹ì€ `printStackTrace()`ë§Œ ì°ê³  ë. ì´ë ‡ê²Œ í•˜ë©´ **ë¬´ì–¸(ç„¡è¨€)ì˜ ì‹¤íŒ¨**ê°€ ìƒê²¨ ì¶”ì  ë¶ˆê°€. ë°˜ë“œì‹œ **ë¡œê¹… + ì „íŒŒ** ë˜ëŠ” **ë¡œê¹… + ë³€í™˜ í›„ ì „íŒŒ** í•˜ì.
2. **ìì› ëˆ„ìˆ˜**: ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ê°€ ë‚˜ë©´ `close()`ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ â†’ `try-with-resources`(Java) / Kotlinì˜ `use {}`ë¡œ ìë™ í•´ì œ.   ë˜í•œ â€œì˜ˆì™¸ ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ ì‹¤í–‰â€ ë³´ì¥ì„ ìœ„í•´ `finally`ë¥¼ ì‚¬ìš©(ì–¸ì–´ê°€ ì§€ì› ì‹œ).
3. **íë¦„ ì œì–´ë¡œ ì˜ˆì™¸ ë‚¨ìš©**: ì •ìƒ ë¶„ê¸°(ì˜ˆ: ê°’ì´ ì—†ìŒ/ì¡°ê±´ ë¶ˆì¼ì¹˜)ë¥¼ ì˜ˆì™¸ë¡œ ì²˜ë¦¬í•˜ë©´ í˜¸ì¶œì ë¡œì§ì´ ì˜ˆì™¸ì ì¸ ë¶„ê¸°ë“¤ë¡œ ì˜¤ì—¼ë˜ê³  ë¹„ìš©ê¹Œì§€ ì¦ê°€. ì´ëŸ° ê²½ìš°ëŠ” `Result/Either/Try` ê°™ì€ **ê°’ ê¸°ë°˜ ê²°ê³¼**(í•¨ìˆ˜í˜•)ë¡œ ëª¨ë¸ë§í•˜ëŠ” ê²ƒì´ ë°”ëŒì§.

> âœï¸ ì§§ì€ ì²¨ì–¸: â€œì˜ˆì™¸ëŠ” ì˜ˆì™¸ì ì¸ ìƒí™©â€ì¼ ë•Œë§Œ ì“°ì„¸ìš”. **ë¹ˆ ì»¬ë ‰ì…˜/ì˜µì…”ë„/ë„ë©”ì¸ ê²°ê³¼ íƒ€ì…**ìœ¼ë¡œ ì¶©ë¶„íˆ í‘œí˜„ ê°€ëŠ¥í•œ ê²ƒë“¤ì€ ì˜ˆì™¸ ëŒ€ì‹  ê°’ìœ¼ë¡œ ëŒë ¤ì£¼ëŠ” ê²Œ ìœ ì§€ë³´ìˆ˜/ì„±ëŠ¥ ëª¨ë‘ ì´ì .

---

# (ì°¸ê³ ) â€œLet it crashâ€ ì² í•™ê³¼ì˜ ì¡°í™”

* ì—ë¦­ìŠ¨/Erlang/ì•„ì¹´(Akka)ì˜ **ìŠˆí¼ë¹„ì „/Let-it-crash**ëŠ” **ê²½ëŸ‰ í”„ë¡œì„¸ìŠ¤/ì•¡í„° ê²©ë¦¬**ê°€ ì „ì œì¼ ë•Œ ìœ íš¨. JVM ì›¹ì•±ì˜ ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤/ìŠ¤ë ˆë“œ í’€ ëª¨ë¸ì— ë¬´ë¹„íŒ ì ìš©ì€ ìœ„í—˜. ë‹¤ë§Œ **ì•¡í„°/ì›Œí¬ ë‹¨ìœ„ ê²©ë¦¬**ê°€ ìˆëŠ” ê³³ì—ì„œëŠ” â€œì¹˜ëª…ì  ì˜¤ë¥˜ ì‹œ ì¬ì‹œì‘â€ ì „ëµì´ ìœ íš¨í•˜ë‹¤. ([Akka Documentation][1], [SoftwareMill Tech Blog][2], [Medium][3])
* Akka Typed ì•¡í„°ëŠ” ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ ì¤‘ì§€ë˜ëŠ” íŠ¹ì§•ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” Classic Akka ì•¡í„°ê°€ ê¸°ë³¸ì ìœ¼ë¡œ ì¬ì‹œì‘ë˜ëŠ” ê²ƒê³¼ëŠ” ë‹¤ë¥¸ ì¤‘ìš”í•œ ì°¨ì´ì ì…ë‹ˆë‹¤

## ì‹¤íŒ¨ ìœ í˜• êµ¬ë¶„
### Validation Error vs Failure
- **Validation Error (ê²€ì¦ ì˜¤ë¥˜)** ëŠ” ì•¡í„°ì—ê²Œ ë³´ë‚´ì§„ ëª…ë ¹ì˜ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°ë¡œ, ì´ëŠ” ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¤ê¸°ë³´ë‹¤ëŠ” `ì•¡í„° í”„ë¡œí† ì½œì˜ ì¼ë¶€ë¡œ ëª¨ë¸ë§`ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
- **Failure (ì‹¤íŒ¨)** ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ëŠê¹€ê³¼ ê°™ì´ ì˜ˆìƒì¹˜ ëª»í•œ ìƒí™©ì´ë‚˜ `ì•¡í„°ê°€ ì œì–´í•  ìˆ˜ ì—†ëŠ” ìƒí™©`ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì‹¤íŒ¨ì— ëŒ€í•´ì„œëŠ” "Let it crash" ì² í•™ì„ ì ìš©í•˜ëŠ” ê²ƒì´ ìœ ìš©í•©ë‹ˆë‹¤.


> âœï¸ ì§§ì€ ì²¨ì–¸: â€œì¶©ëŒì„ í—ˆìš©â€í•˜ë ¤ë©´ **ê²©ë¦¬ ë‹¨ìœ„**ê°€ ë¨¼ì € ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì—†ìœ¼ë©´ í•œ ìš”ì²­ì˜ í¬ë˜ì‹œê°€ ì „ì²´ ì„œë¹„ìŠ¤ë¡œ ë²ˆì§ˆ ìˆ˜ ìˆì–´ìš”. ë³¸ë¬¸ë„ ë°”ë¡œ ì´ ì§€ì ì„ ê°•ì¡°í•©ë‹ˆë‹¤.

---

# ë„ë©”ì¸ ì˜ˆì œ (Kotlin) â€” â€œì¿ í° ë°œê¸‰â€ ì‹œë‚˜ë¦¬ì˜¤

## ë°°ê²½

* ë§ˆì¼€í„°ê°€ ìº í˜ì¸ë³„ **ì¿ í° ë°œê¸‰**ì„ ìš”ì²­.
* ì œì•½: ìº í˜ì¸ì´ **í™œì„± ìƒíƒœ**ì—¬ì•¼ í•˜ë©°, **ë°œê¸‰ í•œë„**ì™€ **ì˜ˆì‚°**ì„ ë§Œì¡±í•´ì•¼ í•¨.
* ì™¸ë¶€ ì‹œìŠ¤í…œ(ì¿ í° ì €ì¥ì†Œ, íšŒê³„ API) í˜¸ì¶œ ì¤‘ **ì‹œìŠ¤í…œ ì˜¤ë¥˜**ê°€ ë‚  ìˆ˜ ìˆìŒ.

## AS-IS (ì•ˆí‹° íŒ¨í„´ì´ ì„ì¸ êµ¬í˜„)

ë¬¸ì œì : (1) íë¦„ ì œì–´ë¡œ ì˜ˆì™¸ ë‚¨ë°œ, (2) ì˜ˆì™¸ ì‚¼í‚¤ê¸°, (3) ìì› ëˆ„ìˆ˜ ìœ„í—˜.

```kotlin
// AS-IS: ë‚˜ìœ ì˜ˆ (ì˜ˆì™¸ë¡œ ì •ìƒ ë¶„ê¸°, ì‚¼í‚¤ê¸°, ë¡œê¹…ë§Œ í•˜ê³  ë)
class CouponServiceAsIs(
    private val repo: CouponRepository,     // AutoCloseable ì•„ë‹˜ ê°€ì •
    private val billing: BillingClient      // AutoCloseable
) {
    fun issue(campaignId: String, userId: String): String {
        try {
            // 1) ë„ë©”ì¸ ì •ìƒ ë¶„ê¸°ë¥¼ ì˜ˆì™¸ë¡œ ì²˜ë¦¬(ë‚¨ìš©)
            if (!repo.isCampaignActive(campaignId)) {
                throw IllegalStateException("INACTIVE") // ì •ìƒ ë¶„ê¸°ì¸ë° ì˜ˆì™¸!
            }
            if (repo.issuedCount(campaignId) >= repo.quota(campaignId)) {
                throw RuntimeException("QUOTA_EXCEEDED") // ì—­ì‹œ ì •ìƒ ë¶„ê¸°
            }

            // 2) ì™¸ë¶€ ìì›(close í•„ìš”)ì„ try-finally ì—†ì´ ì‚¬ìš© â†’ ëˆ„ìˆ˜ ìœ„í—˜
            val tx = billing.openTransaction() // ê°€ì •: ëª…ì‹œ close í•„ìš”
            val coupon = repo.createCoupon(campaignId, userId)
            billing.reserveBudget(tx, campaignId, repo.unitCost(campaignId))
            return coupon.code
        } catch (e: Exception) {
            e.printStackTrace() // ğŸ˜± ì‚¼í‚¤ê¸° + í‘œì¤€ì¶œë ¥
            return "FALLBACK"   // ğŸ˜± ì¹¨ë¬µ ì‹¤íŒ¨ + ì˜ë¯¸ ë¶ˆëª… ê²°ê³¼
        }
    }
}
```

## TO-BE (ê°œì„ ) â€” â€œë„ë©”ì¸ ê²°ê³¼ëŠ” ê°’ìœ¼ë¡œ, ì‹œìŠ¤í…œ ì˜¤ë¥˜ë§Œ ì˜ˆì™¸ë¡œâ€, â€œìì›ì€ `use`ë¡œâ€

í•µì‹¬:

* ì •ìƒ ì‹¤íŒ¨(ì¬ê³  ì—†ìŒ/ë¹„í™œì„±/í•œë„ ì´ˆê³¼)ëŠ” **ê°’ ê¸°ë°˜ ê²°ê³¼**(`sealed class IssueResult`)ë¡œ ëª¨ë¸ë§.
* ì™¸ë¶€ ìì›ì€ `AutoCloseable`ì„ êµ¬í˜„í•˜ê³  **`use {}`**ë¡œ ëˆ„ìˆ˜ ë°©ì§€.
* ì‹œìŠ¤í…œ ì˜ˆì™¸ëŠ” **ë¡œê¹… + ë³€í™˜(í•„ìš” ì‹œ) + ì „íŒŒ**.

```kotlin
// ê²°ê³¼ ëª¨ë¸: ë„ë©”ì¸ "ì •ìƒ ì‹¤íŒ¨"ëŠ” ê°’ìœ¼ë¡œ
sealed class IssueResult {
    data class Success(val code: String) : IssueResult()
    data object InactiveCampaign : IssueResult()
    data object QuotaExceeded : IssueResult()
    data object BudgetInsufficient : IssueResult()
}

// ì™¸ë¶€ ìì›: AutoCloseableë¡œ ê°€ì • â†’ Kotlin use{} ê°€ëŠ¥
interface BillingClient : AutoCloseable {
    fun openTransaction(): BillingClient // ë°ëª¨ë¥¼ ìœ„í•´ ìê¸° ìì‹  ë°˜í™˜
    fun reserveBudget(campaignId: String, amount: Long): Boolean
    override fun close()
}

interface CouponRepository {
    fun isCampaignActive(campaignId: String): Boolean
    fun issuedCount(campaignId: String): Int
    fun quota(campaignId: String): Int
    fun unitCost(campaignId: String): Long
    fun createCoupon(campaignId: String, userId: String): Coupon
}

data class Coupon(val code: String)

class CouponService(
    private val repo: CouponRepository,
    private val billingFactory: () -> BillingClient
) {
    fun issue(campaignId: String, userId: String): IssueResult {
        // 1) ë„ë©”ì¸ ì •ìƒ ë¶„ê¸°ëŠ” ê°’ìœ¼ë¡œ í‘œí˜„
        if (!repo.isCampaignActive(campaignId)) return IssueResult.InactiveCampaign
        if (repo.issuedCount(campaignId) >= repo.quota(campaignId)) return IssueResult.QuotaExceeded

        // 2) ì‹œìŠ¤í…œ ìƒí˜¸ì‘ìš©ì€ ì˜ˆì™¸ ê°€ëŠ¥ â†’ use{}ë¡œ ìì› í•´ì œ ë³´ì¥
        return try {
            billingFactory().use { billing ->
                val amount = repo.unitCost(campaignId)
                val ok = billing.reserveBudget(campaignId, amount)
                if (!ok) return IssueResult.BudgetInsufficient

                val coupon = repo.createCoupon(campaignId, userId)
                IssueResult.Success(coupon.code)
            }
        } catch (e: Exception) {
            // ì˜ë¯¸ ìˆëŠ” ë¡œê¹… + ìƒìœ„ ì „íŒŒ ë˜ëŠ” ë§¤í•‘
            // (ì—¬ê¸°ì„  ëŸ°íƒ€ì„ìœ¼ë¡œ ë³€í™˜ í›„ ì „íŒŒ ì˜ˆì‹œ)
            throw IllegalStateException("Failed to issue coupon: ${e.message}", e)
        }
    }
}
```
### use { ... } í•œ ì¥ ìš”ì•½

- ë¬´ì—‡: Closeable/AutoCloseable ë¦¬ì†ŒìŠ¤ë¥¼ ì•ˆì „í•˜ê²Œ ì“°ê³  ë¸”ë¡ ì¢…ë£Œ ì‹œ ë¬´ì¡°ê±´ close í•´ì£¼ëŠ” í™•ì¥ í•¨ìˆ˜.
- ì™œ: ì˜ˆì™¸ê°€ ë‚˜ë”ë¼ë„ ìì› ëˆ„ìˆ˜ ì—†ì´ ë‹«ì•„ì£¼ê³ , block ì˜ˆì™¸ê°€ ìš°ì„ ë˜ë©° close ì¤‘ ì˜ˆì™¸ëŠ” **ì–µì œ(suppressed)** ë¡œ ë¶™ì—¬ì¤Œ.
- ì–¸ì œ: íŒŒì¼/ìŠ¤íŠ¸ë¦¼/JDBC/HTTP í´ë¼ì´ì–¸íŠ¸ ë“± â€œë‹«ì•„ì•¼ í•˜ëŠ”â€ ëª¨ë“  ìì›ì— ì‚¬ìš©.
- íŠ¹ì§•: inline ì´ë¼ use ë¸”ë¡ ì•ˆì˜ returnì´ ë°”ê¹¥ í•¨ìˆ˜ë¡œ ë°”ë¡œ ë°˜í™˜(non-local return).

### Kotest í…ŒìŠ¤íŠ¸ (ì˜ˆì™¸/ì •ìƒ ì‹¤íŒ¨ ëª¨ë‘ ê²€ì¦)

* **ì •ìƒ ì‹¤íŒ¨ëŠ” ê°’ ë§¤ì¹­**
* **ì‹œìŠ¤í…œ ì˜¤ë¥˜ëŠ” `shouldThrow`** ë¡œ ëª…í™• ê²€ì¦( Kotest ë¬¸ì„œ ì°¸ê³  ). ([Kotest][4])

```kotlin
import io.kotest.core.spec.style.StringSpec
import io.kotest.matchers.shouldBe
import io.kotest.assertions.throwables.shouldThrow

class CouponServiceTest : StringSpec({

    "ë¹„í™œì„± ìº í˜ì¸ì€ ê°’ ê¸°ë°˜ ì‹¤íŒ¨ë¥¼ ë°˜í™˜" {
        val repo = stubRepo(active = false)
        val svc = CouponService(repo) { stubBilling(success = true) }
        svc.issue("C1", "U1") shouldBe IssueResult.InactiveCampaign
    }

    "í•œë„ ì´ˆê³¼ëŠ” ê°’ ê¸°ë°˜ ì‹¤íŒ¨ë¥¼ ë°˜í™˜" {
        val repo = stubRepo(issued = 10, quota = 10)
        val svc = CouponService(repo) { stubBilling(success = true) }
        svc.issue("C1", "U1") shouldBe IssueResult.QuotaExceeded
    }

    "ì˜ˆì‚° ë¶€ì¡±ì€ ê°’ ê¸°ë°˜ ì‹¤íŒ¨ë¥¼ ë°˜í™˜" {
        val repo = stubRepo(unitCost = 100)
        val svc = CouponService(repo) { stubBilling(success = false) }
        svc.issue("C1", "U1") shouldBe IssueResult.BudgetInsufficient
    }

    "ì‹œìŠ¤í…œ ì˜¤ë¥˜ëŠ” ì˜ˆì™¸ë¡œ ì „íŒŒ" {
        val repo = object : CouponRepository by stubRepo() {
            override fun createCoupon(campaignId: String, userId: String) =
                throw RuntimeException("db down")
        }
        val svc = CouponService(repo) { stubBilling(success = true) }
        shouldThrow<IllegalStateException> {
            svc.issue("C1", "U1")
        }
    }
})

/** --- í…ŒìŠ¤íŠ¸ìš© ìŠ¤í… --- **/
fun stubRepo(
    active: Boolean = true,
    issued: Int = 0,
    quota: Int = 100,
    unitCost: Long = 10
): CouponRepository = object : CouponRepository {
    override fun isCampaignActive(campaignId: String) = active
    override fun issuedCount(campaignId: String) = issued
    override fun quota(campaignId: String) = quota
    override fun unitCost(campaignId: String) = unitCost
    override fun createCoupon(campaignId: String, userId: String) = Coupon("CP-$userId")
}

fun stubBilling(success: Boolean): BillingClient = object : BillingClient {
    override fun openTransaction(): BillingClient = this
    override fun reserveBudget(campaignId: String, amount: Long) = success
    override fun close() { /* no-op */ }
}
```

> ğŸ’¡ `use {}`ëŠ” Kotlinì—ì„œ Javaì˜ try-with-resourcesì™€ ë™ì¼ ëª©ì . `Closeable/AutoCloseable` ëŒ€ìƒì— ì ìš©ë˜ë©°, ë¸”ë¡ ì¢…ë£Œ ì‹œ ì˜ˆì™¸ ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ `close()`ê°€ í˜¸ì¶œë©ë‹ˆë‹¤. ([Baeldung on Kotlin][5], [Joao Alves][6], [Kotlin Discussions][7])

### JPAì—ì„  ì–´ë–»ê²Œ closeë˜ëŠ”ê±¸ê¹Œ?
- **Spring JPA(=Spring Data JPA + Hibernate)**ì—ì„œëŠ” EntityManager, Hibernate Session, JDBC Connection ê°™ì€ ë¦¬ì†ŒìŠ¤ë¥¼ ìŠ¤í”„ë§ì´ íŠ¸ëœì­ì…˜ ê²½ê³„(@Transactional) ì•ˆì—ì„œ `ìë™ìœ¼ë¡œ ê´€ë¦¬`í•©ë‹ˆë‹¤.
- ê·¸ë˜ì„œ ì¼ë°˜ì ìœ¼ë¡œ close()ë¥¼ ì§ì ‘ í˜¸ì¶œí•  ì¼ì´ ì—†ì—ˆê³ (ë§ì•„ìš”!), ëŒ€ì‹  íŠ¸ëœì­ì…˜ì´ ëë‚  ë•Œ ì ì ˆíˆ flush â†’ commit/rollback â†’ close/ë°˜ë‚©ì´ ì¼ì–´ë‚©ë‹ˆë‹¤.

#### ë‚´ê°€ ì§ì ‘ ê´€ë¦¬í•´ì•¼ ë˜ëŠ” ì¼€ì´ìŠ¤
- Java 8 Stream<T>ë¥¼ ë°˜í™˜í•˜ëŠ” JPA ì¿¼ë¦¬
    - ì˜ˆ: fun findByStatus(status: Status): Stream<Order>
    - ìŠ¤íŠ¸ë¦¼ì€ ì—´ë¦° ì»¤ì„œë¥¼ ì¡ê³  ìˆì„ ìˆ˜ ìˆì–´ìš”.
    - ì•ˆì „í•œ ìŠµê´€: íŠ¸ëœì­ì…˜ ê²½ê³„ ì•ˆì—ì„œ try-with-resources/Kotlin use {}ë¡œ ì†Œë¹„ í›„ ë‹«ê¸°.
    ```kotlin
    @Transactional(readOnly = true)
    fun export(): List<OrderDto> =
        orderRepo.findByStatus(ACTIVE).use { stream ->
            stream.map { it.toDto() }.toList()
        }
    
    ```
- LOB(ëŒ€ìš©ëŸ‰ ë°”ì´ë„ˆë¦¬/í…ìŠ¤íŠ¸) ìŠ¤íŠ¸ë¦¬ë°
  - InputStream/Reader ë“±ì€ JPA ë°–ì˜ ì¼ë°˜ ìì›ì´ë¯€ë¡œ use {}ë¡œ ë‹«ìœ¼ì„¸ìš”.
- ì§ì ‘ ë§Œë“  EntityManager
    - EntityManagerFactory#createEntityManager()ë¡œ ìˆ˜ë™ ìƒì„±í–ˆë‹¤ë©´, ì§ì ‘ em.close() í•´ì•¼ í•©ë‹ˆë‹¤.
    - ë³´í†µì€ ìŠ¤í”„ë§ì´ ì£¼ì…í•´ ì£¼ëŠ”(í”„ë¡ì‹œ) EntityManagerë§Œ ì“°ë©´ ë©ë‹ˆë‹¤.
- JPA ë°–ì˜ ìˆœìˆ˜ JDBC ì‚¬ìš©
    - DataSource.getConnection()ì„ ì§ì ‘ ì—´ì—ˆë‹¤ë©´ use {}(ë˜ëŠ” try-with-resources)ë¡œ ë‹«ê¸°.


---

# í•œëˆˆ ìš”ì•½

* **3.1**: ì˜ˆì™¸ëŠ” ì •ë³´ë‹¤. **Checked**ëŠ” â€œë³µêµ¬ ì˜ë„â€, **Unchecked**ëŠ” â€œí”„ë¡œê·¸ë˜ë° ì˜¤ë¥˜/ì„ í–‰ì¡°ê±´ ìœ„ë°˜/ë³µêµ¬ ë¶ˆê°€â€ë¥¼ ì‹ ì† ì‹¤íŒ¨ë¡œ í‘œëª…. ê´‘ì—­-catchëŠ” ì‰½ì§€ë§Œ **êµ¬ì²´ ì •ë³´ ì†ì‹¤**ì´ í¬ë‹¤.
* **3.2**: **ê³µê°œ API**ëŠ” ì‹¤íŒ¨ë¥¼ **ëª…ì‹œì ìœ¼ë¡œ ê³„ì•½í™”**(Checked); ë¶ˆí•„ìš”í•œ ì¥í™©í•¨ì€ í•„ìš”í•œ ê³³ì—ì„œë§Œ. UncheckedëŠ” **ì„ í–‰ì¡°ê±´ ìœ„ë°˜** ë“± ë¬¸ì„œí™” ìš©ë„ë¡œ ì œí•œì ìœ¼ë¡œ.
* **3.3**: **ì˜ˆì™¸ ì‚¼í‚¤ê¸°**, **ìì› ëˆ„ìˆ˜**, **íë¦„ ì œì–´ë¡œ ì˜ˆì™¸ ë‚¨ìš©** ê¸ˆì§€. ìì›ì€ `try-with-resources`/`use {}`ë¡œ, ì •ìƒ ì‹¤íŒ¨ëŠ” **ê°’ ê²°ê³¼**ë¡œ.

---

# ë” ì½ì„ê±°ë¦¬(ê°„ë‹¨ ì •ë¦¬ + ë§í¬)

* **Java ì˜ˆì™¸ ê°€ì´ë“œ(ì˜¤ë¼í´ íŠœí† ë¦¬ì–¼)**: Checked/Unchecked ì •ì˜, ì–¸ì œ/ì–´ë–»ê²Œ ì‚¬ìš©í• ì§€ ê¸°ë³¸ê¸°. ([Oracle Docs][8])
* **Kotlinì˜ try-with-resources ëŒ€ì•ˆ**: `use {}` í™•ì¥ìœ¼ë¡œ ìì› í•´ì œ ë³´ì¥(2024.03 ìµœì‹  ì •ë¦¬). ([Baeldung on Kotlin][5])
* **Kotestë¡œ ì˜ˆì™¸ í…ŒìŠ¤íŠ¸**: `shouldThrow`, ë©”ì‹œì§€ ê²€ì¦ ë“±. ([Kotest][4])
* **Akka/Erlang â€œLet it crashâ€**: ê²©ë¦¬/ìŠˆí¼ë¹„ì „ì´ ì „ì œì¼ ë•Œ ìœ íš¨í•œ ì „ëµâ€”JVM ì›¹ì•±ì—ì„œì˜ ì ìš© í•œê³„ì™€ í¬ì¸íŠ¸ ì •ë¦¬. ([Akka Documentation][1], [SoftwareMill Tech Blog][2])

---

[1]: https://doc.akka.io/libraries/akka-core/current/typed/fault-tolerance.html?utm_source=chatgpt.com "Fault Tolerance"
[2]: https://blog.softwaremill.com/supervision-error-handling-in-zio-akka-and-monix-part-3-series-summary-abe75f964c2a?utm_source=chatgpt.com "Supervision & error handling in ZIO, Akka and Monix (part ..."
[3]: https://medium.com/%40rng/erlang-a-veterans-take-on-concurrency-fault-tolerance-and-scalability-adff3f96565b?utm_source=chatgpt.com "Erlang: A Veteran's Take on Concurrency, Fault Tolerance, ..."
[4]: https://kotest.io/docs/assertions/exceptions.html?utm_source=chatgpt.com "Exceptions"
[5]: https://www.baeldung.com/kotlin/try-with-resources?utm_source=chatgpt.com "Try-with-resources in Kotlin"
[6]: https://joaoalves.dev/posts/kotlin-playground/kotlin-trywithresources-use/?utm_source=chatgpt.com "Kotlin try-with-resources â€” use - Joao Alves"
[7]: https://discuss.kotlinlang.org/t/closing-db-connection/2393?utm_source=chatgpt.com "Closing DB connection"
[8]: https://docs.oracle.com/javase/tutorial/essential/exceptions/index.html?utm_source=chatgpt.com "Lesson: Exceptions - Javaâ„¢ Tutorials"
