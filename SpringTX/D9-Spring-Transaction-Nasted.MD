μΆ‹μ•„, μ¤λ 9μΌμ°¨ ν•™μµ μ£Όμ μΈ \*\*μ¤‘μ²©(Nested) νΈλμ­μ…κ³Ό μ €μ¥μ (Savepoint)\*\*μ— λ€ν•΄ κµ¬μ΅°μ μΌλ΅ μ„¤λ…ν•κ³ , Kotlin μμ μ™€ ν•¨κ» μ‹¤λ¬΄ λ„λ©”μΈ κΈ°λ°μΌλ΅ `as-is / to-be` μμ λ¥Ό μ κ³µν• κ².

---

## π“ ν•µμ‹¬ μ£Όμ  κ°μ”

### 1. β… μ¤‘μ²©(Nested) νΈλμ­μ…μ΄λ€?

* ν•λ‚μ νΈλμ­μ… μ•μ—μ„ λ λ‹¤λ¥Έ νΈλμ­μ…μ„ μ‹μ‘ν•λ” κµ¬μ΅°
* Springμ—μ„λ” μ‹¤μ  DB μμ¤€μ μ¤‘μ²© νΈλμ­μ…μ„ μ§€μ›ν•μ§€ μ•μ β†’ λ€μ‹  **μ €μ¥μ (Savepoint)** μ„ μ΄μ©ν•μ—¬ μ μ‚¬ν• μ¤‘μ²© ν¨κ³Ό μ κ³µ
* `PROPAGATION_NESTED` μ „ν μ†μ„±μ„ μ‚¬μ©ν•  λ• μ €μ¥μ μ„ κΈ°μ¤€μΌλ΅ rollback κ°€λ¥

### 2. β… μ €μ¥μ (Savepoint)μ΄λ€?

* νΈλμ­μ… λ‚΄ νΉμ • μ‹μ μ— μ„¤μ •ν•λ” **μΌμΆ…μ λ¶λ§ν¬**
* μ „μ²΄ νΈλμ­μ…μ„ rollback ν•μ§€ μ•κ³ , μ €μ¥μ κΉμ§€ λ¶€λ¶„ rollback κ°€λ¥
* JDBC APIμ—μ„ `Connection.setSavepoint()`, `rollback(Savepoint)` μΌλ΅ μ μ–΄

### 3. β… JDBC vs JTA μ¤‘μ²© νΈλμ­μ… μ°¨μ΄

| ν•­λ©          | JDBC (Spring κΈ°λ³Έ)                         | JTA (λ¶„μ‚° νΈλμ­μ…)        |
| ----------- | ---------------------------------------- | -------------------- |
| μ§€μ› μ—¬λ¶€       | μ €μ¥μ  κΈ°λ°μΌλ΅ μ¤‘μ²© μ μ‚¬ μ§€μ› (`PROPAGATION_NESTED`) | μ‹¤μ  μ¤‘μ²© νΈλμ­μ… λ¶κ°€        |
| νΈλμ­μ… κ²½κ³„     | λ‹¨μΌ DB μ»¤λ„¥μ…                                | XAResource, κΈ€λ΅λ² νΈλμ­μ… |
| rollback λ€μƒ | Savepoint κΉμ§€                             | μ „μ—­ νΈλμ­μ… μ „μ²΄ λ€μƒ        |
| λ³µμ΅λ„         | λ‚®μ                                       | λ†’μ                   |



### β… JDBC νΈλμ­μ… (`DataSourceTransactionManager`)

### π“ μ–Έμ  μ‚¬μ©ν•λ‚?

* **λ‹¨μΌ λ°μ΄ν„°μ†μ¤(λ‹¨μΌ DB)** λ¥Ό μ‚¬μ©ν•λ” λ€λ¶€λ¶„μ Spring μ• ν”λ¦¬μΌ€μ΄μ…
* μ: MySQL λλ” PostgreSQL ν• κ° DBλ§ μ‚¬μ©ν•λ” μ›Ή μ„λΉ„μ¤

### π“ νΉμ§•

* λΉ λ¥΄κ³  μ„¤μ •μ΄ κ°„λ‹¨ν•¨
* μ €μ¥μ (Savepoint) λ“± JDBCμ κΈ°λ¥μ„ κ·Έλ€λ΅ μ‚¬μ© κ°€λ¥
* `PROPAGATION_NESTED` μ§€μ› κ°€λ¥
* λ΅μ»¬ νΈλμ­μ…(1κ°μ μ»¤λ„¥μ… κΈ°λ°)


### β… JTA νΈλμ­μ… (`JtaTransactionManager`)

### π“ μ–Έμ  μ‚¬μ©ν•λ‚?

* **2κ° μ΄μƒμ λ°μ΄ν„°μ†μ¤ λλ” λ¶„μ‚° μμ›(DB + MQ + μ™Έλ¶€ μ„λΉ„μ¤ λ“±)** μ„ ν•λ‚μ νΈλμ­μ…μΌλ΅ λ¬¶κ³ μ ν•  λ•
* μ: A DBμ— μ“°κ³  B DBμ— μ“°κ³  MQμ—λ„ λ©”μ‹μ§€λ¥Ό λ„£λ” μ‘μ—…μ„ ν•λ‚μ νΈλμ­μ…μΌλ΅ λ¬¶κ³  μ‹¶μ„ λ•

### π“ νΉμ§•

* **κΈ€λ΅λ²(λ¶„μ‚°) νΈλμ­μ…** κ΄€λ¦¬
* XA ν”„λ΅ν† μ½μ„ ν†µν•΄ κ° μμ› κ°„ 2-phase commit μν–‰
* μ„¤μ • λ³µμ΅, μ„±λ¥ μ¤λ²„ν—¤λ“ μμ
* `PROPAGATION_NESTED`μ€ μ§€μ›ν•μ§€ μ•μ (JTA νΈλμ­μ…μ—μ„ savepoint λ¶κ°€)

---

## π“ μ„ νƒ κΈ°μ¤€ μ”μ•½

| μƒν™©                                               | μ„ νƒν•  νΈλμ­μ… λ§¤λ‹μ €                          |
| ------------------------------------------------ | ------------------------------------- |
| λ‹¨μΌ DBλ§ μ‚¬μ©ν•λ” μ• ν”λ¦¬μΌ€μ΄μ…                               | `DataSourceTransactionManager` (JDBC) |
| λ‹¤μ¤‘ DB λλ” DB + MQ, μ™Έλ¶€ νΈλμ­μ…μ„ λ¬¶μ–΄μ•Ό ν•¨                 | `JtaTransactionManager` (JTA)         |
| `@Transactional(propagation = NESTED)`μ„ μ¨μ•Ό ν•λ” κ²½μ° | JDBC κΈ°λ°λ§ κ°€λ¥                           |
| νΈλμ­μ… μ†λ„μ™€ λ‹¨μμ„±μ΄ μ¤‘μ”ν•  κ²½μ°                             | JDBC μ°μ„  κ³ λ ¤                            |
| WAS λ…λ¦½ νΈλμ­μ… κ΄€λ¦¬κ°€ ν•„μ”ν•  λ•                            | JTA κ³ λ ¤ (μ: Spring Boot + Atomikos)    |

---

### π”§ μμ‹ μ„¤μ • λΉ„κµ

### β–¶ JDBC κΈ°λ° μ„¤μ • (λ‹¨μΌ DB)

```kotlin
@Bean
fun transactionManager(dataSource: DataSource): PlatformTransactionManager {
    return DataSourceTransactionManager(dataSource)
}
```

### β–¶ JTA κΈ°λ° μ„¤μ • (Atomikos μ)

```kotlin
@Bean
fun transactionManager(): PlatformTransactionManager {
    return JtaTransactionManager()
}
```

### π§  κ²°λ΅ 
λ€λ¶€λ¶„μ Spring Boot μ• ν”λ¦¬μΌ€μ΄μ…μ€ JDBC κΈ°λ°μΌλ΅ μ¶©λ¶„ν•λ©°,

JTAλ” λ¶„μ‚° νΈλμ­μ…μ΄ ν•„μ”ν• λ³µμ΅ν• λ§μ΄ν¬λ΅μ„λΉ„μ¤ μ•„ν‚¤ν…μ²λ‚ λΉ„μ¦λ‹μ¤ λ‹¨μ„μ—μ„ μ›μμ„±μ΄ μ¤‘μ”ν• μ‘μ—…μ—λ§ μ ν•μ μΌλ΅ μ‚¬μ©λΌ.

μ‹¤λ¬΄μ—μ„λ” JDBC λ°©μ‹ + λ³΄μƒ νΈλμ­μ…(Saga ν¨ν„΄) μ΅°ν•©μΌλ΅ `JTAλ¥Ό ν”Όν•λ” κ²½μ°κ°€ λ§μ•„.`

---

## π§  ν•¨κ» ν•™μµν•λ©΄ μΆ‹μ€ κ°λ…

* Savepointμ™€ rollback νλ¦„ (commit/rollback κ΄€κ³„)
* μμ™Έ λ°μƒ μ‹ savepoint rollback μ μ© μ „λµ
* νΈλμ­μ… λ™κΈ°ν™” (`TransactionSynchronizationManager`)
* `DataSourceTransactionManager` λ‚΄λ¶€ κµ¬ν„

---

## π“ μ €μ¥μ  κΈ°λ° λ΅¤λ°± ν”λ΅μ° (Flowchart)

```mermaid
flowchart TD
    A[Outer Transaction Start] --> B[Create Savepoint - Nested Tx μ‹μ‘]
    B --> C[Nested Logic μν–‰]
    C --> D{μμ™Έ λ°μƒ μ—¬λ¶€}
    D -- Yes --> E[Rollback to Savepoint]
    D -- No --> F[Nested Tx Commit]
    E --> G[Outer Logic κ³„μ† μ§„ν–‰]
    F --> G
    G --> H[Outer Transaction Commit]

```

---

## π‘¨β€π’» Kotlin μμ  (λ„λ©”μΈ: μ£Όλ¬Έ(Order)κ³Ό ν¬μΈνΈ μ²λ¦¬)

### π“ As-Is (λ¨λ“  λ΅μ§μ΄ ν•λ‚μ νΈλμ­μ…μ— λ¬¶μ—¬ μμ™Έ μ‹ μ „μ²΄ λ΅¤λ°±)

```kotlin
@Transactional
fun placeOrder(userId: Long, amount: Int) {
    orderService.createOrder(userId, amount) // μ£Όλ¬Έ μƒμ„±
    pointService.usePoint(userId, amount)    // ν¬μΈνΈ μ°¨κ°

    // ν¬μΈνΈ μ°¨κ° μ‹¤ν¨ β†’ μ£Όλ¬Έλ„ λ΅¤λ°±
}
```

---

### π“ To-Be (`@Transactional(propagation = NESTED)`λ΅ μ¤‘μ²© νΈλμ­μ… μ²λ¦¬)

```kotlin
@Transactional
fun placeOrder(userId: Long, amount: Int) {
    orderService.createOrder(userId, amount) // μ£Όλ¬Έ μƒμ„±

    try {
        pointService.usePointWithNestedTx(userId, amount)
    } catch (e: Exception) {
        log.warn("ν¬μΈνΈ μ°¨κ° μ‹¤ν¨: {}", e.message)
        // μ£Όλ¬Έμ€ μ μ§€λμ§€λ§, ν¬μΈνΈλ§ rollback λ¨
    }
}

@Service
class PointService {

    @Transactional(propagation = Propagation.NESTED)
    fun usePointWithNestedTx(userId: Long, amount: Int) {
        if (amount > 10000) throw IllegalStateException("λ„λ¬΄ λ§μ€ ν¬μΈνΈ μ‚¬μ©")
        // ν¬μΈνΈ μ°¨κ° λ΅μ§
    }
}
```

---

## π§© λ‚΄λ¶€ κµ¬ν„ ν•™μµ ν¬μΈνΈ

* `DataSourceTransactionManager#doBegin()`μ—μ„ `ConnectionHolder` μ €μ¥
* `AbstractPlatformTransactionManager` β†’ `useSavepointForNestedTransaction() == true`μΌ λ• savepoint μƒμ„±
* `ConnectionHolder.createSavepoint()` β†’ μ‹¤μ  JDBC API νΈμ¶
* rollback μ‹ savepoint κΈ°μ¤€μΌλ΅ μ²λ¦¬ (`rollbackToSavepoint`)

---

## π§Ύ μ”μ•½ μ •λ¦¬

| ν•­λ©             | λ‚΄μ©                                                                   |
| -------------- | -------------------------------------------------------------------- |
| μ¤‘μ²© νΈλμ­μ…        | νΈλμ­μ… μ•μ—μ„ λ λ‹¤λ¥Έ νΈλμ­μ…μ„ μ‹μ‘ν•λ” λ°©μ‹ (Springμ—μ„λ” Savepointλ΅ μ μ‚¬ κµ¬ν„)             |
| μ €μ¥μ (Savepoint) | νΈλμ­μ… λ‚΄ λ¶λ§ν¬, ν•΄λ‹Ή μ‹μ κΉμ§€ rollback κ°€λ¥                                      |
| JDBC           | Savepoint κΈ°λ° μ¤‘μ²© νΈλμ­μ… μ§€μ›                                              |
| JTA            | μ €μ¥μ  κ°λ… μ—†μ, μ „μ—­ νΈλμ­μ…λ§ rollback λ€μƒ                                      |
| μ‹¤λ¬΄ μ‚¬μ© μ        | λ³΄μ΅° μ‘μ—… μ‹¤ν¨ μ‹ ν•µμ‹¬ λ„λ©”μΈ μ‘μ—… μ μ§€ (ex. μ£Όλ¬Έμ€ μ„±κ³µ, ν¬μΈνΈλ§ μ‹¤ν¨)                        |
| μ£Όμμ‚¬ν•­           | `PROPAGATION_NESTED`λ” `DataSourceTransactionManager`μ—μ„λ§ μ§€μ›λ¨ (JTA μ•„λ‹) |

---

## λ‚΄μƒκ°
> ν¬κ² μ‚¬μ©ν• μΌμ€ μ—†μ„κ²ƒ κ°™λ‹¤λ” μƒκ°μ΄ λ“¤κΈ΄ ν•¨. μ„μ—μ„λ„ JDBC λ°©μ‹κ³Ό SAGA ν¨ν„΄μΌλ΅ JTAλ” ν”Όν•κ³  μλ‹¤κ³  μ΄μ•ΌκΈ° ν•¨. <br/>
> μ¤νλ ¤ JDBC+λ°©μ‹κ³Ό Saga ν¨ν„΄μ μ‹¬λ„μλ” ν•™μµμ΄ ν•„μ”ν•λ‹¤λ” μƒκ°μ΄ λ“¬.