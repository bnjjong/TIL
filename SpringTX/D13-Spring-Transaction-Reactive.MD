## ğŸ“Œ 1. ë¦¬ì•¡í‹°ë¸Œ íŠ¸ëœì­ì…˜ì´ë€?

### ğŸ”¸ ì „í†µ íŠ¸ëœì­ì…˜ vs ë¦¬ì•¡í‹°ë¸Œ íŠ¸ëœì­ì…˜

| êµ¬ë¶„     | ì „í†µ íŠ¸ëœì­ì…˜                      | ë¦¬ì•¡í‹°ë¸Œ íŠ¸ëœì­ì…˜                        |
| ------ | ---------------------------- | -------------------------------- |
| ê¸°ë°˜     | ì“°ë ˆë“œ ë°”ì¸ë”©                      | ë…¼ë¸”ë¡œí‚¹, ì´ë²¤íŠ¸ ë£¨í”„                     |
| ì²˜ë¦¬ ë°©ì‹  | `@Transactional` ì„ ì–¸ì  ì²˜ë¦¬      | `TransactionalOperator` í”„ë¡œê·¸ë˜ë° ë°©ì‹ |
| ì»¤ë„¥ì…˜ ê´€ë¦¬ | ThreadLocal                  | Context ë°”ì¸ë”©                      |
| ì˜ˆì™¸ ì²˜ë¦¬  | ëª…ì‹œì  rollback / checked ì˜ˆì™¸ ì§€ì› | `.doOnError` ë° ì²´ì¸ rollback ì²˜ë¦¬    |

---

## ğŸ“Œ 2. í•µì‹¬ ê°œë…: `TransactionalOperator`

Springì˜ ë¦¬ì•¡í‹°ë¸Œ íŠ¸ëœì­ì…˜ ê´€ë¦¬ë¥¼ ìœ„í•œ í•µì‹¬ ìœ í‹¸ì…ë‹ˆë‹¤.

```kotlin
val txOperator = TransactionalOperator.create(r2dbcTransactionManager)
```

* `txOperator.execute { txStatus -> publisher }`
* íŠ¸ëœì­ì…˜ ë²”ìœ„ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •
* rollbackì€ ì˜ˆì™¸ ë˜ëŠ” `txStatus.setRollbackOnly()`ë¡œ ìˆ˜í–‰

---

## ğŸ“Œ 3. ë¦¬ì•¡í‹°ë¸Œ íŠ¸ëœì­ì…˜ íë¦„ (Mermaid)

```mermaid
flowchart TD
  A["Reactive Service í˜¸ì¶œ"] --> B["txOperator.execute {...}"]
  B --> C["DB ì—°ì‚° 1 (insert/update/delete)"]
  C --> D["DB ì—°ì‚° 2"]
  D --> E{ì˜ˆì™¸ ë°œìƒ ì—¬ë¶€?}
  E -- "ì •ìƒ" --> F["commit"]
  E -- "ì˜ˆì™¸" --> G["rollback"]
```

---

## ğŸ“Œ 4. ì‹¤ìŠµ ì¤€ë¹„: R2DBC + PostgreSQL + Spring Boot

### ğŸ”¸ Gradle

```kotlin
dependencies {
    implementation("org.springframework.boot:spring-boot-starter-data-r2dbc")
    implementation("io.r2dbc:r2dbc-postgresql")
    runtimeOnly("org.postgresql:postgresql")
}
```

---

## ğŸ“Œ 5. ì˜ˆì œ ë„ë©”ì¸ ì†Œê°œ

* `User`ê°€ `Wallet`ì„ ìƒì„±í•˜ê³  ì¼ì • ê¸ˆì•¡ì„ ì¶©ì „í•˜ëŠ” ë¡œì§
* ì¶©ì „ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ëª¨ë“  ì²˜ë¦¬ëŠ” rollback ë˜ì–´ì•¼ í•¨

---

## ğŸ“Œ 6. ì˜ˆì œ ì½”ë“œ: As-Is (íŠ¸ëœì­ì…˜ ì—†ì´)

### âœ… ë„ë©”ì¸

```kotlin
data class User(val id: Long, val name: String)
data class Wallet(val id: Long, val userId: Long, val balance: Int)
```

### âœ… ì„œë¹„ìŠ¤

```kotlin
fun charge(userId: Long, amount: Int): Mono<Void> {
    return walletRepository.findByUserId(userId)
        .flatMap { wallet ->
            walletRepository.updateBalance(wallet.id, wallet.balance + amount)
        }
        .then(Mono.error(RuntimeException("ì„ì˜ ì˜ˆì™¸"))) // rollback ì•ˆë¨
}
```

### âŒ ë¬¸ì œì :

* íŠ¸ëœì­ì…˜ì´ ì—†ì–´ ì¤‘ê°„ ì˜ˆì™¸ ë°œìƒí•´ë„ updateê°€ DBì— ë°˜ì˜ë¨

---

## ğŸ“Œ 7. ì˜ˆì œ ì½”ë“œ: To-Be (TransactionalOperator ì ìš©)

### âœ… ì„¤ì •

```kotlin
@Bean
fun transactionalOperator(tm: R2dbcTransactionManager): TransactionalOperator {
    return TransactionalOperator.create(tm)
}
```

### âœ… ê°œì„ ëœ ì„œë¹„ìŠ¤

```kotlin
fun charge(userId: Long, amount: Int): Mono<Void> {
    return txOperator.execute { status ->
        walletRepository.findByUserId(userId)
            .flatMap { wallet ->
                walletRepository.updateBalance(wallet.id, wallet.balance + amount)
            }
            .then(Mono.error(RuntimeException("ì¶©ì „ ì‹¤íŒ¨")))
    }.then() // rollback ìë™ ìˆ˜í–‰
}
```

---

## ğŸ“Œ 8. ì¶”ê°€ë¡œ í•™ìŠµí•  ë‚´ìš© ì œì•ˆ

| ì£¼ì œ                                          | ì´ìœ                                            |
| ------------------------------------------- | -------------------------------------------- |
| âœ… ConnectionFactory vs DataSource           | ë¦¬ì•¡í‹°ë¸Œì—ì„œëŠ” `ConnectionFactory`ë¥¼ ì‚¬ìš©              |
| âœ… `DatabaseClient` vs `R2dbcEntityTemplate` | ì„ ì–¸ì /SQL ê¸°ë°˜ DB ì²˜ë¦¬ ë°©ì‹ ì°¨ì´                       |
| âœ… ContextPropagation & ReactorContext       | íŠ¸ëœì­ì…˜ ì •ë³´ëŠ” ThreadLocal ëŒ€ì‹  Reactor Contextë¡œ ì „ë‹¬ë¨ |
| âœ… Kotlin Coroutines + R2DBC                 | `suspend` ë°©ì‹ê³¼ `reactor` ë°©ì‹ í†µí•© ê³ ë ¤             |

---

## ğŸ“Œ 9. ìš”ì•½ ì •ë¦¬

| í•­ëª©    | ë‚´ìš©                                                 |
| ----- | -------------------------------------------------- |
| ëª©ì     | ë…¼ë¸”ë¡œí‚¹ í™˜ê²½ì—ì„œì˜ íŠ¸ëœì­ì…˜ ë³´ì¥                                 |
| í•µì‹¬ ë„êµ¬ | `TransactionalOperator`, `R2dbcTransactionManager` |
| ì˜ˆì™¸ ì²˜ë¦¬ | `.doOnError`, ì˜ˆì™¸ ë¦¬í„´ ì‹œ rollback                     |
| ì‚¬ìš© ì´ìœ  | Reactor í™˜ê²½ì—ì„œ ì„ ì–¸ì  `@Transactional`ì´ ë™ì‘í•˜ì§€ ì•Šê¸° ë•Œë¬¸      |
| ì‚¬ìš© ë°©ì‹ | `txOperator.execute { publisher }`ë¡œ íŠ¸ëœì­ì…˜ ë²”ìœ„ ëª…ì‹œ     |

---

í•„ìš”í•˜ì‹œë©´ ì´ ë¡œì§ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œë‚˜ ì½”ë£¨í‹´ ì ìš© ì˜ˆì œë„ ì¶”ê°€ë¡œ ì œê³µë“œë¦´ ìˆ˜ ìˆì–´ìš”. ë‹¤ìŒìœ¼ë¡œ í™•ì¥í•˜ê³  ì‹¶ì€ ë°©í–¥ì´ ìˆë‹¤ë©´ ì•Œë ¤ì£¼ì„¸ìš”!
