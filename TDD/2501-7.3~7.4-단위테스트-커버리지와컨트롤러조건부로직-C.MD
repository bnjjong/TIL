## 7.3 ìµœì ì˜ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¶„ì„

* í—˜ë¸” ê°ì²´(=ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ë¶„ë¦¬)ë¡œ ë¦¬íŒ©í„°ë§í•œ ë’¤, â€œë¬´ì—‡ì„ ì–´ë””ì—ì„œ ì–´ë–»ê²Œ í…ŒìŠ¤íŠ¸í• ì§€â€ë¥¼ ì‚¬ë¶„ë©´ìœ¼ë¡œ ì •ë¦¬í•œë‹¤. í‘œ 7.1ì´ ëŒ€í‘œ ì˜ˆë‹¤ \[p.248] .
* í•µì‹¬ ë©”ì‹œì§€: **ë³µì¡ë„ì™€ ë„ë©”ì¸ ìœ ì˜ì„±ì´ ë†’ì€ ì½”ë“œ**ë¥¼ **í˜‘ë ¥ì(ì™¸ë¶€ ì˜ì¡´)** ê±°ì˜ ì—†ì´ ë‘ë©´, íšŒê·€ ë°©ì§€ íš¨ê³¼ê°€ í¬ê³  ìœ ì§€ë¹„ê°€ ë‚®ë‹¤ \[p.248] .

### í‘œ 7.1 ì½”ë“œ ìœ í˜•(ì‚¬ë¶„ë©´) â€“ ì§ì ‘ ì¬ì‘ì„±

|                   | í˜‘ë ¥ì ì ìŒ                                                                          | í˜‘ë ¥ì ë§ìŒ                                                                   |
| ----------------- | ------------------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| **ë³µì¡ë„Â·ë„ë©”ì¸ ìœ ì˜ì„± â†‘** | `User.ChangeEmail(newEmail, company)`, `Company.ChangeNumberOfEmployees(delta)` | (ë¦¬íŒ©í„°ë§ìœ¼ë¡œ ì œê±°ë¨) `UserController.ChangeEmail(userId,newEmail)`ì€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ìœ¼ë¡œ ì´ë™ |
| **ë³µì¡ë„Â·ë„ë©”ì¸ ìœ ì˜ì„± â†“** | `IsEmailCorporate(email)`, `CompanyFactory.Create(data)`, `User/Company` ìƒì„±ì    | (í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì•„ë‹˜ ë˜ëŠ” ë‹¤ìŒ ì¥ì—ì„œ í†µí•© ê´€ì )                                              |

> ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ì„ ë¶„ë¦¬í•˜ë©´ â€œë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë‹¨ìœ„â€ê°€ ëª…í™•í•´ì§„ë‹¤ \[p.248] .

### 7.3.1 ë„ë©”ì¸/ìœ í‹¸ë¦¬í‹°ë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë²•

* **ê°€ì¥ ê°€ì¹˜ ë†’ì€ í…ŒìŠ¤íŠ¸ ì§€ì ** = *ë³µì¡ë„â†‘Â·ë„ë©”ì¸ ìœ ì˜ì„±â†‘Â·í˜‘ë ¥ìâ†“* (ì˜ˆ: `User.ChangeEmail`) \[p.248] .
* `Company.IsEmailCorporate()` ê°™ì€ ìœ í‹¸ ë©”ì„œë“œëŠ” **ë§¤ê°œë³€ìˆ˜í™” í…ŒìŠ¤íŠ¸**ë¡œ ë¬¶ì–´ ê°„ê²°í•˜ê²Œ ì»¤ë²„ \[p.249] .

### 7.3.2 ë‚˜ë¨¸ì§€ ì‚¬ë¶„ë©´ì˜ í…ŒìŠ¤íŠ¸ ì „ëµ

* **ë‹¨ìˆœ ìƒì„±ì** ë“±ì€ í…ŒìŠ¤íŠ¸ ê°€ì¹˜ê°€ ë‚®ìŒ(íšŒê·€ ë°©ì§€ íš¨ê³¼ ë¯¸ë¯¸) \[p.249] .
* **í˜‘ë ¥ì ë§ì€ ë³µì¡ ì½”ë“œ**ëŠ” ë¦¬íŒ©í„°ë§ìœ¼ë¡œ ì œê±°í–ˆê³ , **ì»¨íŠ¸ë¡¤ëŸ¬ ì‚¬ë¶„ë©´**ì€ ë‹¤ìŒ ì¥ì—ì„œ í†µí•© ê´€ì ìœ¼ë¡œ ë‹¤ë£¬ë‹¤ \[p.249] .

### 7.3.3 ì „ì œ ì¡°ê±´(Precondition)ì„ í…ŒìŠ¤íŠ¸í•´ì•¼ í•˜ëŠ”ê°€?

* **ë„ë©”ì¸ ìœ ì˜ì„± ìˆëŠ” ì „ì œ ì¡°ê±´**(ì˜ˆ: ì§ì› ìˆ˜ëŠ” ìŒìˆ˜ ë¶ˆê°€)ì€ í…ŒìŠ¤íŠ¸ ê°€ì¹˜ê°€ í¬ë‹¤. í´ë˜ìŠ¤ ë¶ˆë³€ì„±ì˜ ì¼ë¶€ì´ê¸° ë•Œë¬¸ \[p.250] .
* ë°˜ëŒ€ë¡œ **ë„ë©”ì¸ ì˜ë¯¸ ì—†ëŠ” ë³´í˜¸ ì¥ì¹˜**(ì˜ˆ: íŒ©í† ë¦¬ ì¸ì ê¸¸ì´ ì²´í¬)ëŠ” êµ³ì´ í…ŒìŠ¤íŠ¸í•˜ì§€ ì•Šì•„ë„ ëœë‹¤ \[p.250] .
> ğŸ¤” ë„ë©”ì¸ ì˜ë¯¸ ì—†ëŠ” ë³´í˜¸ ì¥ì¹˜ë€ ë¬´ì—‡ì¼ê¹Œ? ë„ë©”ì¸ì˜ í•´ë‹¹í•˜ì§€ ì•ŠëŠ” ê¸°ìˆ ì , ìŠ¤í™ì  í…ŒìŠ¤íŠ¸ë¥¼ ì˜ë¯¸í•˜ëŠ” ë“¯ í•˜ë‹¤.
#### ë„ë©”ì¸ ì˜ë¯¸ ì—†ëŠ” ë³´í˜¸ ì¥ì¹˜ì˜ ì˜ˆ
ì—¬ê¸°ì„œ ë§í•˜ëŠ” \*\*"ë„ë©”ì¸ ì˜ë¯¸ ì—†ëŠ” ë³´í˜¸ ì¥ì¹˜"\*\*ëŠ”
ì „ì œ ì¡°ê±´(Precondition) ì¤‘ì—ì„œ **ì—…ë¬´ ê·œì¹™ê³¼ ì§ì ‘ì ì¸ ì—°ê´€ì´ ì—†ëŠ” ë‹¨ìˆœí•œ ì•ˆì „ ì¥ì¹˜**ë¥¼ ëœ»í•´ìš”.

* **ë„ë©”ì¸ ì˜ë¯¸ ìˆëŠ” ì „ì œ ì¡°ê±´**

  * **ì—…ë¬´ ê·œì¹™**ì— í•´ë‹¹í•˜ëŠ” ì¡°ê±´
  * ì˜ˆ: "íšŒì‚¬ì˜ ì§ì› ìˆ˜ëŠ” ìŒìˆ˜ê°€ ë  ìˆ˜ ì—†ë‹¤"

    * íšŒì‚¬ë¼ëŠ” ë„ë©”ì¸ì—ì„œ `ì§ì› ìˆ˜ â‰¥ 0`ì€ í•„ìˆ˜ ë¶ˆë³€ì‹
    * ì´ ê·œì¹™ì´ ê¹¨ì§€ë©´ ì—…ë¬´ ë¡œì§ì´ ì˜ëª»ëœ ê²ƒì´ë¯€ë¡œ í…ŒìŠ¤íŠ¸ ê°€ì¹˜ê°€ í¼

* **ë„ë©”ì¸ ì˜ë¯¸ ì—†ëŠ” ì „ì œ ì¡°ê±´**

  * ì—…ë¬´ ê·œì¹™ì´ ì•„ë‹ˆë¼, **ë‹¨ìˆœí•œ ì½”ë“œ ì•ˆì „ì„±**ì„ ìœ„í•œ ì¡°ê±´
  * ì˜ˆ: `UserFactory.Create()`ì—ì„œ `data.length >= 3` ì²´í¬

    * ë‹¨ìˆœíˆ ë°°ì—´ ì¸ë±ìŠ¤ ì—ëŸ¬ë¥¼ ë°©ì§€í•˜ëŠ” ìˆ˜ì¤€
    * "ì™œ 3ì´ì–´ì•¼ í•˜ëŠ”ì§€"ëŠ” ë„ë©”ì¸ ê·œì¹™ì´ ì•„ë‹ˆë¼ êµ¬í˜„ ë°©ì‹ì—ì„œ ë‚˜ì˜¨ ì œì•½
    * ì´ëŸ° ê±´ í…ŒìŠ¤íŠ¸í•  ê°€ì¹˜ê°€ ë‚®ìŒ (ëŒ€ë¶€ë¶„ ê°œë°œìê°€ ì‹¤ìˆ˜í•˜ì§€ ì•ŠëŠ” í•œ ë²„ê·¸ë¡œ ì´ì–´ì§ˆ ê°€ëŠ¥ì„±ì´ ë‚®ê³ , í…ŒìŠ¤íŠ¸ ìœ ì§€ë³´ìˆ˜ ë¹„ìš©ë§Œ ëŠ˜ì–´ë‚¨)


---

## 7.4 ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì¡°ê±´ë¶€ ë¡œì§ ì²˜ë¦¬

* **ì½ê¸°â†’ê²°ì •â†’ì“°ê¸°**ì˜ 3ë‹¨ê³„ êµ¬ì¡°ì¼ ë•Œ, ì™¸ë¶€ ì˜ì¡´ì„±(DB, ë©”ì‹œì§€ ë²„ìŠ¤ ë“±)ì€ ì—°ì‚°ì˜ **ê°€ì¥ìë¦¬**ë¡œ ë°€ì–´ë‚´ëŠ” ê²Œ ì´ìƒì ì´ë‹¤(ìœ¡ê°í˜•/í•¨ìˆ˜í˜• ì•„í‚¤í…ì²˜) \[p.251] .
> ğŸ¤” out adapterë¡œ ë¶„ë¦¬ë¥¼ ì˜ë¯¸í•¨.
* í•˜ì§€ë§Œ í˜„ì‹¤ì—ì„  ì¤‘ê°„ ì˜ì‚¬ê²°ì • ê²°ê³¼ì— ë”°ë¼ *ì¶”ê°€ ì¡°íšŒ/ì“°ê¸°*ê°€ í•„ìš”í•´ì§€ë©°(ê·¸ë¦¼ 7.11), ì„¸ ê°€ì§€ ì ˆì¶©ì´ ìƒê¸´ë‹¤ \[p.252-253]  .
> ì´ëŸ° ê²½ìš°ëŠ” ë¹ˆë²ˆí•˜ë‹¤. íŠ¹íˆ ì¡°íšŒ.

### (ê·¸ë¦¼ 7.12) ì„¸ íŠ¹ì„±ì˜ ì ˆì¶© â€” ì§ì ‘ í‘œë¡œ ì¬êµ¬ì„±

| ë°©ë²•                  | ì»¨íŠ¸ë¡¤ëŸ¬ ë‹¨ìˆœì„± | ë„ë©”ì¸ ëª¨ë¸ í…ŒìŠ¤íŠ¸ ìœ ì˜ì„± | ì„±ëŠ¥           |
| ------------------- | -------- | -------------- | ------------ |
| **ì½ê¸°/ì“°ê¸°ë¥¼ ê°€ì¥ìë¦¬ë¡œ ëª°ê¸°** | â— ì¢‹ìŒ     | â— ì¢‹ìŒ           | â—‹ ë‚˜ì¨(ë¶ˆí•„ìš” í˜¸ì¶œ) |
| **ë„ë©”ì¸ì— ì™¸ë¶€ ì˜ì¡´ ì£¼ì…**   | â— ì¢‹ìŒ     | â—‹ ë‚˜ì¨(í˜‘ë ¥ìâ†‘)     | â— ì¢‹ìŒ         |
| **ê²°ì • ë‹¨ê³„ë¥¼ ì„¸ë¶„í™”**      | â—‹ ë³µì¡â†‘    | â— ì¢‹ìŒ           | â— ì¢‹ìŒ         |

> í˜„ì‹¤ì ìœ¼ë¡œ 1ì•ˆ(ì„±ëŠ¥ ì €í•˜)ì€ ë°°ì œ, 2ì•ˆ(ì˜ì¡´ ì£¼ì…)ì€ í…ŒìŠ¤íŠ¸ì„± ì•…í™” â†’ **3ì•ˆ(ì„¸ë¶„í™”)** ì„ íƒí•˜ë˜, ë³µì¡ë„ ìƒìŠ¹ì„ ê´€ë¦¬í•´ì•¼ í•œë‹¤ \[p.253] .

- 3ì•ˆì˜ ê²½ìš° ì•„ë˜ í”Œë¡œìš°ë¥¼ ì°¸ì¡°í•˜ì.
> ğŸ˜ ë³´í†µ í•µì‚¬ê³ ë‚ ì—ì„œëŠ” ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ì„œ ì•„ë˜ ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•œë‹¤.
```
Step 1: ê¸°ë³¸ ë°ì´í„° ì½ê¸° (DB ì¡°íšŒ)
Step 2: 1ì°¨ íŒë‹¨ (ë„ë©”ì¸ ë¡œì§)
Step 3: í•„ìš”í•˜ë©´ ì™¸ë¶€ API í˜¸ì¶œ (ì¶”ê°€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°)
Step 4: 2ì°¨ íŒë‹¨ (ë„ë©”ì¸ ë¡œì§)
Step 5: ê²°ê³¼ ì €ì¥ (DB ì €ì¥)
```

### 7.4.1 CanExecute/Execute íŒ¨í„´

* ë¹„ì¦ˆë‹ˆìŠ¤ ê²°ì •ì„ **ë„ë©”ì¸ ëª¨ë¸ ë‚´ë¶€ì— ìœ ì§€**í•˜ë©´ì„œë„ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ë¶„ê¸° ë‚œë¦½ì„ ë§‰ëŠ” ë°©ë²•.
* `User.CanChangeEmail()`ë¡œ **ì‚¬ì „ ì§ˆì˜** â†’ `User.ChangeEmail()`ì˜ **ì „ì œ ì¡°ê±´**ìœ¼ë¡œ ê°•ì œ \[p.256-257]  .
* ì´ íŒ¨í„´ì˜ íš¨ê³¼:

  1. ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” â€œê°€ëŠ¥í•œê°€?â€ë§Œ ë¬¼ìŒ â†’ ë‚´ë¶€ ê²€ì¦ì€ ìº¡ìŠí™” \[p.257] .
  2. ì‚¬ì „ í™•ì¸ ì—†ì´ ìˆ˜í–‰ ë¶ˆê°€(ì „ì œì¡°ê±´) â†’ ì¼ê´€ì„± í™•ë³´ \[p.257] .

### 7.4.2 ë„ë©”ì¸ ì´ë²¤íŠ¸ë¡œ ë³€ê²½ ì‚¬í•­ ì¶”ì 

* â€œë¬´ì—‡ì´ *ì‹¤ì œë¡œ ì¼ì–´ë‚¬ëŠ”ì§€*â€ë¥¼ **ë„ë©”ì¸ ì´ë²¤íŠ¸**ë¡œ ê¸°ë¡ â†’ ì—°ì‚°ì´ ëë‚œ ë’¤ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì´ë²¤íŠ¸ë¥¼ ì™¸ë¶€ ë©”ì‹œì§€ë¡œ ë³€í™˜ \[p.258-261]  .
* ì˜ˆ: ì´ë©”ì¼ì´ ì‹¤ì œë¡œ ë°”ë€Œì—ˆì„ ë•Œë§Œ `EmailChangedEvent` ì¶”ê°€ â†’ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” í•´ë‹¹ ì´ë²¤íŠ¸ë“¤ì„ ë©”ì‹œì§€ ë²„ìŠ¤ë¡œ ë°œí–‰í•œë‹¤ \[p.260-261]  .
* DB ì €ì¥ì€ í•­ìƒ í•˜ë˜(ORMì€ ë³€ê²½ ì—†ìœ¼ë©´ no-opì¼ ìˆ˜ ìˆìŒ), **ë©”ì‹œì§€ ë°œí–‰ì€ ì´ë²¤íŠ¸ ìœ ë¬´ë¡œ ì œì–´**í•œë‹¤. ì™¸ë¶€ ê³„ì•½ì„ ì§€í‚¤ê¸° ìœ„í•¨ì´ë‹¤ \[p.261] .

---

## âœï¸ Kotlin ì˜ˆì œ (as-is â†’ to-be, ë„ë©”ì¸ í¬í•¨)

### ë„ë©”ì¸ ì‹œë‚˜ë¦¬ì˜¤

* **ê´‘ê³  í”Œë«í¼ CRM**: ì‚¬ìš©ìì˜ ì´ë©”ì¼ ë³€ê²½ ì •ì±…

  * íšŒì‚¬ ë„ë©”ì¸ ì´ë©”ì¼ì´ë©´ `Employee`, ì•„ë‹ˆë©´ `Customer`.
  * ì´ë©”ì¼ì´ \*\*í™•ì¸(confirmed)\*\*ëœ í›„ì—ëŠ” ë³€ê²½ ë¶ˆê°€.
  * ì‹¤ì œë¡œ **ë°”ë€ ê²½ìš°ì—ë§Œ** ì™¸ë¶€ ë©”ì‹œì§€(`EmailChanged`) ì „ì†¡.

---

### (AS-IS) ì»¨íŠ¸ë¡¤ëŸ¬ ë¶„ê¸° ë§ìŒ + ì´ë²¤íŠ¸ ë¯¸ì‚¬ìš©

```kotlin
// ë„ë©”ì¸ (ì˜ì¡´ ìº¡ìŠí™” ë¯¸í¡)
data class Company(val domain: String, var numberOfEmployees: Int) {
    fun isCorporate(email: String) = email.endsWith("@$domain")
    fun changeNumberOfEmployees(delta: Int) {
        require(numberOfEmployees + delta >= 0) { "employees cannot be negative" } // ë„ë©”ì¸ ì „ì œì¡°ê±´
        numberOfEmployees += delta
    }
}

enum class UserType { Customer, Employee }

data class User(
    val id: Long,
    var email: String,
    var type: UserType,
    var isEmailConfirmed: Boolean
) {
    // ë„ë©”ì¸ ë‚´ë¶€ì— ê²°ì • ë¡œì§ì´ ìˆê¸´ í•˜ë‚˜, ì»¨íŠ¸ë¡¤ëŸ¬ì™€ ë¶„ì‚°ë  ì—¬ì§€ ë†’ìŒ
    fun changeEmail(newEmail: String, company: Company) {
        if (email == newEmail) return
        val newType = if (company.isCorporate(newEmail)) UserType.Employee else UserType.Customer
        if (type != newType) {
            val delta = if (newType == UserType.Employee) 1 else -1
            company.changeNumberOfEmployees(delta)
        }
        email = newEmail
        type = newType
    }
}

// ì™¸ë¶€ í¬íŠ¸
interface MessageBus { fun sendEmailChanged(userId: Long, newEmail: String) }
interface UserRepository { fun findById(id: Long): User; fun save(user: User) }
interface CompanyRepository { fun get(): Company; fun save(company: Company) }

// AS-IS ì»¨íŠ¸ë¡¤ëŸ¬: ë¶„ê¸°Â·ì™¸ë¶€ í˜¸ì¶œ ì„ì„(í…ŒìŠ¤íŠ¸ ì·¨ì•½)
class UserController(
    private val users: UserRepository,
    private val companies: CompanyRepository,
    private val bus: MessageBus
) {
    fun changeEmail(userId: Long, newEmail: String): String {
        val user = users.findById(userId)
        if (user.isEmailConfirmed) return "Can't change a confirmed email" // ì»¨íŠ¸ë¡¤ëŸ¬ ë¶„ê¸°

        val company = companies.get()
        val oldEmail = user.email
        user.changeEmail(newEmail, company)

        companies.save(company)
        users.save(user)
        bus.sendEmailChanged(userId, newEmail) // ë°”ë€Œì§€ ì•Šì•„ë„ ì „ì†¡ë  ìœ„í—˜

        return if (oldEmail == newEmail) "OK (no-op)" else "OK"
    }
}
```

### (TO-BE) CanExecute/Execute + ë„ë©”ì¸ ì´ë²¤íŠ¸ + ì»¨íŠ¸ë¡¤ëŸ¬ ë‹¨ìˆœí™”

```kotlin
// ë„ë©”ì¸ ì´ë²¤íŠ¸
data class EmailChangedEvent(val userId: Long, val newEmail: String)

// ë„ë©”ì¸
data class Company(val domain: String, var numberOfEmployees: Int) {
    fun isCorporate(email: String) = email.endsWith("@$domain")
    fun changeNumberOfEmployees(delta: Int) {
        require(numberOfEmployees + delta >= 0) { "employees cannot be negative" } // ì „ì œì¡°ê±´(ë„ë©”ì¸ ìœ ì˜ì„± æœ‰) [í…ŒìŠ¤íŠ¸ ëŒ€ìƒ]
        numberOfEmployees += delta
    }
}

enum class UserType { Customer, Employee }

class User(
    val id: Long,
    email: String,
    type: UserType,
    private var emailConfirmed: Boolean
) {
    var email: String = email; private set
    var type: UserType = type; private set

    // ì—°ì‚° ê²°ê³¼(ì‚¬ì´ë“œì´í™íŠ¸)ë¥¼ ë©”ëª¨ë¦¬ì— ë³´ë¥˜
    private val _domainEvents = mutableListOf<EmailChangedEvent>()
    val domainEvents: List<EmailChangedEvent> get() = _domainEvents

    // CanExecute: ì»¨íŠ¸ë¡¤ëŸ¬ ë¶„ê¸° ì œê±°ìš© ì§ˆì˜
    fun canChangeEmail(): String? =
        if (emailConfirmed) "Can't change a confirmed email" else null

    // Execute: ì „ì œì¡°ê±´ìœ¼ë¡œ Canì„ ê°•ì œí•˜ì—¬ ì˜¤ìš© ë°©ì§€
    fun changeEmail(newEmail: String, company: Company) {
        require(canChangeEmail() == null) { "Precondition failed: cannot change confirmed email" }

        if (email == newEmail) return // ì‹¤ì œ ë³€ê²½ ì—†ìœ¼ë©´ ì´ë²¤íŠ¸ X

        val newType = if (company.isCorporate(newEmail)) UserType.Employee else UserType.Customer
        if (type != newType) {
            val delta = if (newType == UserType.Employee) 1 else -1
            company.changeNumberOfEmployees(delta)
        }
        email = newEmail
        type = newType
        _domainEvents += EmailChangedEvent(id, newEmail) // ì‹¤ì œ ë³€ê²½ì‹œì—ë§Œ ì´ë²¤íŠ¸ ì¶”ê°€
    }
}

// í¬íŠ¸
interface MessageBus { fun sendEmailChanged(userId: Long, newEmail: String) }
interface UserRepository { fun findById(id: Long): User; fun save(user: User) }
interface CompanyRepository { fun get(): Company; fun save(company: Company) }

// ì»¨íŠ¸ë¡¤ëŸ¬: ì˜ì‚¬ê²°ì • ì œê±°, ì´ë²¤íŠ¸ ë³€í™˜ë§Œ ë‹´ë‹¹
class UserController(
    private val users: UserRepository,
    private val companies: CompanyRepository,
    private val bus: MessageBus
) {
    fun changeEmail(userId: Long, newEmail: String): String {
        val user = users.findById(userId)
        user.canChangeEmail()?.let { return it } // ë„ë©”ì¸ ê²°ì • ì‚¬ìš©

        val company = companies.get()
        user.changeEmail(newEmail, company)

        companies.save(company)
        users.save(user)

        // ë„ë©”ì¸ ì´ë²¤íŠ¸ â†’ ì™¸ë¶€ ë©”ì‹œì§€
        user.domainEvents.forEach { ev ->
            bus.sendEmailChanged(ev.userId, ev.newEmail)
        }
        return "OK"
    }
}
```

#### Kotest ì˜ˆì‹œ(í•µì‹¬ ì‹œë‚˜ë¦¬ì˜¤)

```kotlin
import io.kotest.core.spec.style.StringSpec
import io.kotest.matchers.shouldBe
import io.kotest.matchers.collections.shouldContainExactly

class UserDomainTest : StringSpec({

    "íšŒì‚¬ ì´ë©”ì¼ë¡œ ë³€ê²½í•˜ë©´ ì§ì› ìˆ˜ +1, íƒ€ì… ë³€ê²½, ì´ë²¤íŠ¸ 1ê±´ ìƒì„±" {
        val company = Company(domain = "mycorp.com", numberOfEmployees = 1)
        val user = User(id = 1, email = "user@gmail.com", type = UserType.Customer, emailConfirmed = false)

        user.changeEmail("user@mycorp.com", company)

        company.numberOfEmployees shouldBe 2
        user.email shouldBe "user@mycorp.com"
        user.type shouldBe UserType.Employee
        user.domainEvents.shouldContainExactly(EmailChangedEvent(1, "user@mycorp.com"))
    }

    "ê°™ì€ ì´ë©”ì¼ë¡œ ë³€ê²½í•˜ë©´ no-op: ì§ì› ìˆ˜/íƒ€ì…/ì´ë²¤íŠ¸ ë³€í™” ì—†ìŒ" {
        val company = Company("mycorp.com", 1)
        val user = User(1, "user@mycorp.com", UserType.Employee, emailConfirmed = false)

        user.changeEmail("user@mycorp.com", company)

        company.numberOfEmployees shouldBe 1
        user.type shouldBe UserType.Employee
        user.domainEvents.size shouldBe 0
    }

    "í™•ì¸ëœ ì´ë©”ì¼ì€ ë³€ê²½ ë¶ˆê°€(CanExecute ì „ì œì¡°ê±´ ìœ„ë°˜)" {
        val company = Company("mycorp.com", 1)
        val user = User(1, "user@gmail.com", UserType.Customer, emailConfirmed = true)

        user.canChangeEmail() shouldBe "Can't change a confirmed email"
    }

    "ë„ë©”ì¸ ì „ì œì¡°ê±´: ì§ì› ìˆ˜ ìŒìˆ˜ ë¶ˆê°€" {
        val company = Company("mycorp.com", 0)
        val ex = kotlin.runCatching { company.changeNumberOfEmployees(-1) }.exceptionOrNull()
        require(ex is IllegalArgumentException) { "should fail with precondition" }
    }
})
```

> ìœ„ **to-be** êµ¬ì„±ì€ ì±…ì˜ CanExecute/Execute íŒ¨í„´ê³¼ **ë„ë©”ì¸ ì´ë²¤íŠ¸** ìš´ìš©ì„ Kotlinìœ¼ë¡œ ì˜®ê¸´ ê²ƒì´ë‹¤. ì»¨íŠ¸ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸ì˜ ë¶€ë‹´ì„ ë„ë©”ì¸ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ë¡œ í¬ê²Œ ì˜®ê²¨ì˜¨ë‹¤ \[p.257-261]  .

---

## ë¹ ë¥¸ ë ˆí¼ëŸ°ìŠ¤ í‘œ/ì´ë¯¸ì§€ ìš”ì•½ (ë³¸ë¬¸ ë°˜ì˜)

### â€œì½ê¸°â€“ê²°ì •â€“ì“°ê¸°â€ 3ë‹¨ê³„ & ì™¸ë¶€ ì˜ì¡´ì„± ê°€ì¥ìë¦¬ ë°°ì¹˜

* ì™¸ë¶€ ì˜ì¡´ í˜¸ì¶œì€ ì—°ì‚°ì˜ **ê°€ì¥ìë¦¬**ë¡œ ë°€ì–´ë‚´ë©´ í…ŒìŠ¤íŠ¸ ìš©ì´ì„±ì´ ì¦ê°€í•œë‹¤(ìœ¡ê°í˜•/í•¨ìˆ˜í˜• ì•„í‚¤í…ì²˜) \[p.251] .

### ì„¸ ê°€ì§€ ì ˆì¶©(ê·¸ë¦¼ 7.12 ì¬êµ¬ì„±)

* **ë‹¨ìˆœì„± vs í…ŒìŠ¤íŠ¸ ìœ ì˜ì„± vs ì„±ëŠ¥** â€” ì„¸ ê°€ì§€ ëª¨ë‘ë¥¼ ë™ì‹œì— ë§Œì¡±í•˜ëŠ” í•´ë²•ì€ ì—†ê³ , **ë‘ ê°€ì§€ë¥¼ ì„ íƒ**í•´ì•¼ í•œë‹¤ \[p.253] .

---

## ì¸í„°ë„· ì°¸ê³ ìë£Œ (ê°„ëµ ì •ë¦¬ + ë§í¬)

* **ë„ë©”ì¸ ì´ë²¤íŠ¸(DDD)**: ìƒíƒœ ë³€í™” ì‚¬ì‹¤ì„ ì¼ê¸‰ ê°ì²´ë¡œ ëª¨ë¸ë§. ì´ë²¤íŠ¸ ì†Œì‹±ê³¼ë„ ë°€ì ‘. ì»¨í…ìŠ¤íŠ¸ ê°„ ê²°í•©ì„ ë‚®ì¶”ê³  ì™¸ë¶€ í†µì§€ì— ì í•©. Martin Fowler ê¸€ ì¶”ì²œ. ([martinfowler.com][1])
* **ìœ¡ê°í˜• ì•„í‚¤í…ì²˜(Ports & Adapters)**: ì•±ì„ ì™¸ë¶€ë¡œë¶€í„° ê²©ë¦¬í•´ **í…ŒìŠ¤íŠ¸ ë…ë¦½ì„±**ê³¼ **ê¸°ìˆ  ì„ íƒ ììœ ** í™•ë³´. Cockburn ì›ê¸€Â·ë°œí‘œ ìë£Œ ì¶”ì²œ. ([Alistair Cockburn][2], [Alistair Cockburn][3], [AWS Documentation][4])
* **ì „ì œì¡°ê±´/ì„¤ê³„ ê³„ì•½(Design by Contract)**: ì „ì œì¡°ê±´Â·ë¶ˆë³€ì‹Â·ì‚¬í›„ì¡°ê±´ì„ ëª…ì‹œí•´ â€œë¹ ë¥´ê²Œ ì‹¤íŒ¨â€í•˜ê²Œ ë§Œë“¤ê³ , *ë„ë©”ì¸ ìœ ì˜ì„± ìˆëŠ”* ì „ì œì¡°ê±´ì€ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ. MS Code ContractsÂ·DbC ê°œìš” ì°¸ê³ . ([Microsoft Learn][5], [ìœ„í‚¤ë°±ê³¼][6])
* **ë¬´ì—‡ì„ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸í• ê¹Œ?** ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ëŒ€ê°œ í†µí•© í…ŒìŠ¤íŠ¸ê°€ ì í•©, ë„ë©”ì¸ ëª¨ë¸Â·ì•Œê³ ë¦¬ì¦˜ ìª½ì´ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ì˜ ë‹¨ë§›. (í˜„ ê¸€ê³¼ ë™ì¼í•œ ë°©í–¥ì„±) ([Julio Casal][7])
* **ì €ì ë¸”ë¡œê·¸**(V. Khorikov): ì±… ë°°ê²½ê³¼ ì›ì¹™ë“¤ ì •ë¦¬. í…ŒìŠ¤íŠ¸ê°€ ì¢‹ì€ ì•„í‚¤í…ì²˜ë¥¼ ìœ ë„í•œë‹¤. ([Khorikov][8], [Enterprise Craftsmanship][9], [Manning Publications][10], [Barnes & Noble][11])

---

## ìš”ì•½

* **7.3**: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê°€ì¹˜ëŠ” **ë„ë©”ì¸ ìœ ì˜ì„±Â·ë³µì¡ë„â†‘ + í˜‘ë ¥ìâ†“** ì˜ì—­ì—ì„œ ìµœëŒ€. ë„ë©”ì¸ ì „ì œì¡°ê±´ ì¤‘ **ì—…ë¬´ ì˜ë¯¸ê°€ ìˆëŠ” ê²ƒ**ì„ í…ŒìŠ¤íŠ¸í•˜ë¼(ì˜ˆ: ì§ì› ìˆ˜ ìŒìˆ˜ ê¸ˆì§€) \[p.248-250]  .
* **7.4**: ì™¸ë¶€ ì˜ì¡´ì´ ì–½íŒ ì¡°ê±´ë¶€ ë¡œì§ì€ **ì„¸ ê°€ì§€ ì ˆì¶©**(ë‹¨ìˆœì„±/í…ŒìŠ¤íŠ¸ì„±/ì„±ëŠ¥) ì¤‘ ì„ íƒ. ì‹¤ë¬´ì—ì„  **ì˜ì‚¬ê²°ì • ë‹¨ê³„ ì„¸ë¶„í™”** + **CanExecute/Execute**ë¡œ ê²°ì •ì„ ë„ë©”ì¸ì— ëª¨ìœ¼ê³ , **ë„ë©”ì¸ ì´ë²¤íŠ¸**ë¡œ ì‹¤ì œ ë³€í™”ë§Œ ì™¸ë¶€ì— í†µì§€í•˜ë¼ \[p.253, 257-261]   .

---

### ì¶”ì²œ íŒŒì¼ëª…

`2501-7.3~7.4-ë‹¨ìœ„í…ŒìŠ¤íŠ¸-ì»¤ë²„ë¦¬ì§€ì™€ì»¨íŠ¸ë¡¤ëŸ¬ì¡°ê±´ë¶€ë¡œì§-P.MD`

[1]: https://martinfowler.com/eaaDev/DomainEvent.html?utm_source=chatgpt.com "Domain Event"
[2]: https://alistair.cockburn.us/hexagonal-architecture?utm_source=chatgpt.com "hexagonal-architecture - Alistair Cockburn"
[3]: https://alistaircockburn.com/Hexagonal%20Budapest%2023-05-18.pdf?utm_source=chatgpt.com "Hexagonal Architecture ( Ports & Adapters )"
[4]: https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/hexagonal-architecture.html?utm_source=chatgpt.com "Hexagonal architecture pattern - AWS Prescriptive Guidance"
[5]: https://learn.microsoft.com/en-us/dotnet/framework/debug-trace-profile/code-contracts?utm_source=chatgpt.com "Code Contracts - .NET Framework"
[6]: https://en.wikipedia.org/wiki/Design_by_contract?utm_source=chatgpt.com "Design by contract"
[7]: https://juliocasal.com/blog/What-To-Unit-Test?utm_source=chatgpt.com "What Should I Unit Test?"
[8]: https://khorikov.org/posts/2019-09-30-book-is-sent-to-production/?utm_source=chatgpt.com "The Unit Testing book is sent to production! - Vladimir Khorikov"
[9]: https://enterprisecraftsmanship.com/book/?utm_source=chatgpt.com "Unit Testing book"
[10]: https://manning.com/books/unit-testing?utm_source=chatgpt.com "Unit Testing Principles, Practices, and Patterns"
[11]: https://www.barnesandnoble.com/w/unit-testing-principles-practices-and-patterns-vladimir-khorikov/1137832071?utm_source=chatgpt.com "Unit Testing Principles, Practices, and Patterns"
