
## 9ì¥ ëª© ì²˜ë¦¬ì— ëŒ€í•œ ëª¨ë²” ì‚¬ë¡€

### 9.1 ëª©ì˜ ê°€ì¹˜ë¥¼ ê·¹ëŒ€í™”í•˜ê¸° [p.313-323]

**í•µì‹¬ ê°œë…**
- ëª©(Mock)ì€ ë¹„ê´€ë¦¬ ì˜ì¡´ì„±(ì™¸ë¶€ ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ í†µì‹ í•˜ëŠ” ë¶€ë¶„)ì—ë§Œ ì‚¬ìš©í•´ì•¼ í•¨.
- í•˜ì§€ë§Œ ì´ ì›ì¹™ë§Œìœ¼ë¡œëŠ” ì¶©ë¶„ì¹˜ ì•Šê³ , ì‹œìŠ¤í…œ ëì—ì„œ ìƒí˜¸ì‘ìš©ì„ ê²€ì¦í•´ì•¼ íšŒê·€ ë°©ì§€ì™€ ë¦¬íŒ©í„°ë§ ë‚´ì„±ì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆë‹¤.

**ì˜ˆì œ (CRM ì‹œìŠ¤í…œ)**
- ê¸°ëŠ¥: ì‚¬ìš©ìì˜ ì´ë©”ì¼ì„ ë³€ê²½í•˜ë©´ ë©”ì‹œì§€ ë²„ìŠ¤ì™€ ë¡œê±°ì— ê¸°ë¡.
- IMessageBus â†’ IBus ê³„ì¸µ êµ¬ì¡°ê°€ ìˆìŒ.
- ì˜ëª»ëœ ì ‘ê·¼: `ì¤‘ê°„ ê³„ì¸µ`(IMessageBus)ì„ ëª© ì²˜ë¦¬.
- ê¶Œì¥ ì ‘ê·¼: ì‹œìŠ¤í…œ ë(IBus)ì„ ëª© ì²˜ë¦¬ â†’ ë” ë§ì€ ì½”ë“œê°€ ì‹¤í–‰ë˜ë©°, ì™¸ë¶€ì™€ ì‹¤ì œ êµí™˜ë˜ëŠ” ë©”ì‹œì§€ í˜•ì‹ì´ ê²€ì¦ë¨.
    - ë¦¬íŒ©í„°ë§ìœ¼ë¡œ IMessageBusê°€ ì—†ì–´ì§€ê±°ë‚˜ êµ¬ì¡°ê°€ ë³€í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ ë°”ë¡œ ê¹¨ì ¸ë²„ë¦¼. â†’ í…ŒìŠ¤íŠ¸ê°€ "êµ¬í˜„ ì„¸ë¶€ì‚¬í•­"ì— ë¬¶ì—¬ë²„ë¦¬ê²Œ ë¨.

#### 9.1.1 ì‹œìŠ¤í…œ ëì—ì„œ ê²€ì¦ [p.317-320]
- IMessageBus ëŒ€ì‹  IBusë¥¼ ëŒ€ìƒìœ¼ë¡œ ê²€ì¦.
- ì™¸ë¶€ì™€ êµí™˜ë˜ëŠ” ë©”ì‹œì§€ì˜ ì‹¤ì œ í…ìŠ¤íŠ¸ë¥¼ ê²€ì¦í•˜ë¯€ë¡œ íšŒê·€ ë°©ì§€ íš¨ê³¼â†‘, ë¦¬íŒ©í„°ë§ ë‚´ì„±â†‘.
- ì»¨íŠ¸ë¡¤ëŸ¬, EventDispatcher ë“±ì€ ë‚´ë¶€ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­ì¼ ë¿ â†’ í…ŒìŠ¤íŠ¸ê°€ ê·¸ê²ƒì— ë¬¶ì´ë©´ ì·¨ì•½í•´ì§.
- "ì‹œìŠ¤í…œ ë(system boundary)ì— ìˆëŠ” ì˜ì¡´ì„±ì„ ëª© ì²˜ë¦¬í•˜ë¼." 
    - ì¦‰, ê°€ì¥ ë§ˆì§€ë§‰ì— ì™¸ë¶€ì™€ ì§ì ‘ í†µì‹ í•˜ëŠ” ê³„ì¸µ(IBus)ì„ ëª©ìœ¼ë¡œ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.
![alt text](./images/2501-9.1~9.2-ë‹¨ìœ„í…ŒìŠ¤íŠ¸-ëª©ì²˜ë¦¬ëª¨ë²”ì‚¬ë¡€-C-1.png)

#### 9.1.2 ëª© ëŒ€ì‹  ìŠ¤íŒŒì´ ì‚¬ìš© [p.321-323]
- ìŠ¤íŒŒì´(Spy)ëŠ” ì§ì ‘ ì‘ì„±í•œ Mock.
- ì¥ì : 
    - ê²€ì¦ ë¡œì§ì„ ì¬ì‚¬ìš© â†’ í…ŒìŠ¤íŠ¸ í¬ê¸° ì¶•ì†Œ, ê°€ë…ì„± â†‘.
    - í”Œë£¨ì–¸íŠ¸ ì¸í„°í˜ì´ìŠ¤ ì œê³µ ê°€ëŠ¥.
    - í…ŒìŠ¤íŠ¸ëŠ” ì œí’ˆ ì½”ë“œì˜ í´ë˜ìŠ¤(MessageBus)ê°€ ì•„ë‹ˆë¼ ë…ë¦½ì ì¸ Spyë¥¼ ì‚¬ìš©í•´ì•¼ ì‹ ë¢°ì„± â†‘.

#### 9.1.3 IDomainLogger ë‹¤ë£¨ê¸° [p.323]
- ë©”ì‹œì§€ ë²„ìŠ¤ëŠ” ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ ì§ì ‘ í†µì‹ í•˜ë¯€ë¡œ êµ¬ì¡°ê°€ ì¤‘ìš” â†’ ì‹œìŠ¤í…œ ëì—ì„œ ê²€ì¦ í•„ìš”.
- ë¡œê·¸ëŠ” ì™¸ë¶€ ë…ì(ìš´ì˜ì, ê´€ë¦¬ì)ì—ê²Œ ì •ë³´ë§Œ ì „ë‹¬í•˜ë©´ ë˜ë¯€ë¡œ, IDomainLogger ì¸í„°í˜ì´ìŠ¤ ìˆ˜ì¤€ì—ì„œ ëª© ì²˜ë¦¬í•´ë„ ì¶©ë¶„.

---

### ğŸ’¡ ì œ ìƒê°
- ë©”ì‹œì§€ ë²„ìŠ¤ëŠ” **ì§„ì§œ ì™¸ë¶€ ê³„ì•½**ì´ë¯€ë¡œ ë°˜ë“œì‹œ ëë‹¨ ë©”ì‹œì§€ë¥¼ ê²€ì¦í•´ì•¼ í•œë‹¤ëŠ” ì ì´ í•µì‹¬.
- ë¡œê¹…ì€ ë‹¨ìˆœ ëª¨ë‹ˆí„°ë§ ìš©ë„ì´ë¯€ë¡œ êµ³ì´ ëë‹¨ê¹Œì§€ ê²€ì¦í•  í•„ìš” ì—†ìŒ â†’ í…ŒìŠ¤íŠ¸ ë¹„ìš©ê³¼ ê°€ì¹˜ì˜ ê· í˜•ì„ ì˜ ì„¤ëª…í•œ ë¶€ë¶„.
- ì‹¤ë¬´ì—ì„œë„ ë©”ì‹œì§€ í(Kafka, RabbitMQ) í†µí•© í…ŒìŠ¤íŠ¸ ì‹œ **ì‹¤ì œ ë°œí–‰ëœ ë©”ì‹œì§€**ë¥¼ ê²€ì¦í•˜ëŠ” ìŠµê´€ì´ ì¤‘ìš”í•˜ë‹¤ê³  ëŠë‚Œ.
- í…ŒìŠ¤íŠ¸ëŠ” **ì™¸ë¶€ ì„¸ê³„ì™€ì˜ ì•½ì†**ì„ ê²€ì¦í•´ì•¼ì§€, **ë‚´ë¶€ êµ¬í˜„ì´ ì–´ë–»ê²Œ ëŒì•„ê°€ëŠ”ì§€**ì— ì§‘ì°©í•˜ë©´ ì•ˆ ëœë‹¤ëŠ” ëœ».

---

### 9.2 ëª© ì²˜ë¦¬ì— ëŒ€í•œ ëª¨ë²” ì‚¬ë¡€ [p.324-328]

**ëª¨ë²” ì‚¬ë¡€ ì •ë¦¬**
1.	ëª©ì€ í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œë§Œ ì‚¬ìš©
	- `ë‹¨ìœ„ í…ŒìŠ¤íŠ¸`ì—ì„œëŠ” `ëª© ì‚¬ìš© ê¸ˆì§€`.
	- ë„ë©”ì¸ ëª¨ë¸ = ìˆœìˆ˜ ë¡œì§ â†’ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸.
	- ì»¨íŠ¸ë¡¤ëŸ¬ = ì™¸ë¶€ ì˜ì¡´ì„± í†µì‹  â†’ í†µí•© í…ŒìŠ¤íŠ¸ (ì—¬ê¸°ì„œ ëª© í™œìš©).
2.	ëª©ì€ ì—¬ëŸ¬ ê°œ ì‚¬ìš© ê°€ëŠ¥
	- â€œí…ŒìŠ¤íŠ¸ë‹¹ ëª© í•˜ë‚˜â€ëŠ” ì˜ëª»ëœ ê·œì¹™.
	- í•„ìš”í•œ ë§Œí¼(=ë™ì‘ ë‹¨ìœ„ì— í•„ìš”í•œ ë§Œí¼) ì‚¬ìš© ê°€ëŠ¥.
3.	í˜¸ì¶œ íšŸìˆ˜ ê²€ì¦ í•„ìˆ˜
	- ê¸°ëŒ€í•œ í˜¸ì¶œì´ ìˆëŠ”ì§€ + ë¶ˆí•„ìš”í•œ í˜¸ì¶œì´ ì—†ëŠ”ì§€ ë‘˜ ë‹¤ í™•ì¸í•´ì•¼ í•¨.
	- Times.Once + VerifyNoOtherCalls() ì‚¬ìš©.
	- Spyë¼ë©´ ShouldSendNumberOfMessages(1) ê°™ì€ ë©”ì„œë“œë¡œ í†µí•© ê²€ì¦.
4.	ë³´ìœ  íƒ€ì…ë§Œ ëª©ìœ¼ë¡œ ì²˜ë¦¬
	- ì„œë“œíŒŒí‹° ë¼ì´ë¸ŒëŸ¬ë¦¬ ìœ„ì— ì–´ëŒ‘í„°ë¥¼ ë§Œë“¤ê³ , ê·¸ ì–´ëŒ‘í„°ë¥¼ ëª© ì²˜ë¦¬.
	- ì´ìœ : ì„œë“œíŒŒí‹° ë³€ê²½ì— ë”°ë¥¸ íŒŒê¸‰íš¨ê³¼ ìµœì†Œí™”(anti-corruption layer).
	- ì˜ˆ: ë©”ì‹œì§€ ë²„ìŠ¤ SDK â†’ IBus ì–´ëŒ‘í„° â†’ ëª© ì²˜ë¦¬.

---

ğŸ’¡ ì œ ìƒê°
	- â€œë³´ìœ  íƒ€ì…ë§Œ ëª©ìœ¼ë¡œ ì²˜ë¦¬â€ ì›ì¹™ì´ íŠ¹íˆ ì¸ìƒ ê¹ŠìŒ. -> ì‰½ê²Œ ì´ì•¼ê¸° í•˜ë©´ ì¸í„°í˜ì´ìŠ¤ë¥¼ ëª©ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•œë‹¤. 
	- ì‹¤ë¬´ì—ì„œë„ ì™¸ë¶€ API/ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ëª© ì²˜ë¦¬í•˜ë©´ ê¹¨ì§€ê¸° ì‰¬ìš´ í…ŒìŠ¤íŠ¸ê°€ ë¨.
	- ì–´ëŒ‘í„° ê³„ì¸µì„ ë‘ëŠ” ê²ƒì´ DDD, í—¥ì‚¬ê³ ë‚  ì•„í‚¤í…ì²˜ì™€ë„ ì˜ ë§ìŒ. -> ì™¸ë¶€ í˜¸ì¶œ ì–´ëŒ‘í„°ëŠ” ëŒ€ë¶€ë¶„ ì¸í„°í˜ì´ìŠ¤ë¡œ êµ¬í˜„ì´ ë˜ì–´ ìˆìœ¼ë©°, êµ¬í˜„ì²´ëŠ” í•´ë‹¹ ë„ë©”ì¸ì—ì„œ ì•Œì§€ ëª»í•¨.

---

ìš”ì•½
- ëª©ì€ ë¹„ê´€ë¦¬ ì˜ì¡´ì„± + ì‹œìŠ¤í…œ ëì—ì„œë§Œ ì‚¬ìš©.
- ì¤‘ê°„ ê³„ì¸µì´ ì•„ë‹ˆë¼ ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” ìµœì¢… ì¸í„°í˜ì´ìŠ¤ë¥¼ ëª©/ìŠ¤íŒŒì´ ì²˜ë¦¬í•´ì•¼ íšŒê·€ ë°©ì§€ì™€ ë¦¬íŒ©í„°ë§ ë‚´ì„±ì´ ë†’ì•„ì§.
- ìŠ¤íŒŒì´ëŠ” ëª©ë³´ë‹¤ ìœ ë¦¬ (ì½”ë“œ ì¬ì‚¬ìš©, ê°€ë…ì„±, ë…ë¦½ì„±).
- ë¡œê¹…ì€ ëë‹¨ê¹Œì§€ ê²€ì¦í•  í•„ìš” ì—†ìŒ â†’ ì¸í„°í˜ì´ìŠ¤ ìˆ˜ì¤€ìœ¼ë¡œ ì¶©ë¶„.
- ëª¨ë²” ì‚¬ë¡€:
    1.	í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œë§Œ ëª© ì‚¬ìš©
    2.	í•„ìš”í•œ ë§Œí¼ ëª© ì‚¬ìš©
    3.	í˜¸ì¶œ íšŸìˆ˜ ë°˜ë“œì‹œ ê²€ì¦
    4.	ì„œë“œíŒŒí‹° ë¼ì´ë¸ŒëŸ¬ë¦¬ ëŒ€ì‹  ë³´ìœ  íƒ€ì…ì„ ëª© ì²˜ë¦¬

---

### Kotlin ì˜ˆì œ ì½”ë“œ

**ë„ë©”ì¸ ì‹œë‚˜ë¦¬ì˜¤: ê³ ê° ì´ë©”ì¼ ë³€ê²½ ì‹œ ë©”ì‹œì§€ ë°œì†¡**

#### As-Is (ì˜ëª»ëœ ëª© ì‚¬ìš©: ì¤‘ê°„ ê³„ì¸µ ëª© ì²˜ë¦¬)

```kotlin
class UserController(
    private val database: Database,
    private val messageBus: IMessageBus,
    private val logger: DomainLogger
) {
    fun changeEmail(userId: Int, newEmail: String): String {
        val user = database.getUser(userId)
        val company = database.getCompany()

        user.changeEmail(newEmail, company)
        database.saveUser(user)
        database.saveCompany(company)

        messageBus.sendEmailChanged(user.id, newEmail) // ì¤‘ê°„ ê³„ì¸µ í˜¸ì¶œ
        logger.userTypeChanged(user.id, "Employee", "Customer")

        return "OK"
    }
}

interface IMessageBus {
    fun sendEmailChanged(userId: Int, newEmail: String)
}
```

í…ŒìŠ¤íŠ¸ (ì¤‘ê°„ ê³„ì¸µ ëª©)

```kotlin
class UserControllerTest : StringSpec({
    "ì´ë©”ì¼ ë³€ê²½ ì‹œ IMessageBus í˜¸ì¶œ ê²€ì¦" {
        val db = InMemoryDatabase()
        val messageBus = mockk<IMessageBus>(relaxed = true)
        val logger = mockk<DomainLogger>(relaxed = true)

        val sut = UserController(db, messageBus, logger)

        sut.changeEmail(1, "new@gmail.com")

        verify(exactly = 1) { messageBus.sendEmailChanged(1, "new@gmail.com") }
    }
})
```



To-Be (ëë‹¨ ê³„ì¸µ ëª©/ìŠ¤íŒŒì´ ì‚¬ìš©)
```kotlin
class MessageBus(private val bus: Bus) {
    fun sendEmailChanged(userId: Int, newEmail: String) {
        val message = "Type: USER EMAIL CHANGED; Id: $userId; NewEmail: $newEmail"
        bus.send(message)
    }
}

interface Bus {
    fun send(message: String)
}

class BusSpy : Bus {
    private val sentMessages = mutableListOf<String>()

    override fun send(message: String) {
        sentMessages.add(message)
    }

    fun shouldSendEmailChanged(userId: Int, newEmail: String) {
        val expected = "Type: USER EMAIL CHANGED; Id: $userId; NewEmail: $newEmail"
        require(sentMessages.contains(expected)) { "Expected message not found" }
    }

    fun shouldSendNumberOfMessages(count: Int) {
        require(sentMessages.size == count) { "Expected $count messages but got ${sentMessages.size}" }
    }
}
```
í…ŒìŠ¤íŠ¸ (ëë‹¨ ê³„ì¸µ ê²€ì¦)
```kotlin
class UserControllerIntegrationTest : StringSpec({
    "ì´ë©”ì¼ ë³€ê²½ ì‹œ ë©”ì‹œì§€ ë²„ìŠ¤ì— ì‹¤ì œ ë©”ì‹œì§€ê°€ ë°œì†¡ëœë‹¤" {
        val db = InMemoryDatabase()
        val busSpy = BusSpy()
        val messageBus = MessageBus(busSpy)
        val logger = mockk<DomainLogger>(relaxed = true)

        val sut = UserController(db, messageBus, logger)

        sut.changeEmail(1, "new@gmail.com")

        busSpy.shouldSendNumberOfMessages(1)
        busSpy.shouldSendEmailChanged(1, "new@gmail.com")
    }
})
```

---

### ì°¸ê³ í•  ë§Œí•œ ì™¸ë¶€ ìë£Œ

### 1. Martin Fowler: *Mocks Arenâ€™t Stubs*

* **ë‚´ìš©**: ëª©(Mock)ê³¼ ìŠ¤í…(Stub)ì˜ ì°¨ì´ë¥¼ ëª…í™•íˆ ì •ì˜.

  * **Stub**: í…ŒìŠ¤íŠ¸ ì¤‘ ê³ ì •ëœ ê°’ì„ ë°˜í™˜í•˜ëŠ” ê°ì²´.
  * **Mock**: íŠ¹ì • ìƒí˜¸ì‘ìš©(í˜¸ì¶œ ì—¬ë¶€, íšŸìˆ˜, ì¸ì ë“±)ì„ ê²€ì¦í•˜ëŠ” ê°ì²´.
* **ì˜ì˜**: í…ŒìŠ¤íŠ¸ ëŒ€ì—­(Test Double)ì„ ì˜¬ë°”ë¥´ê²Œ êµ¬ë¶„í•˜ëŠ” ë° ë„ì›€.
* **ë§í¬**: [martinfowler.com/articles/mocksArentStubs.html](https://martinfowler.com/articles/mocksArentStubs.html)

---

### 2. Steve Freeman & Nat Pryce: *Growing Object-Oriented Software, Guided by Tests*

* **ë‚´ìš©**: TDD ì‹¤ë¬´ ì§€ì¹¨ì„œ.

  * ê°ì²´ì§€í–¥ ì„¤ê³„ì™€ í…ŒìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ë°œì „ì‹œí‚¤ëŠ” ë°©ë²• ì œì‹œ.
  * â€œ**ë³´ìœ  íƒ€ì…ë§Œ ëª© ì²˜ë¦¬**â€ ì›ì¹™ ê°•ì¡° â†’ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì•„ë‹Œ **ìš°ë¦¬ ì½”ë“œì˜ ì¶”ìƒí™” ê³„ì¸µ**ì„ ëª© ì²˜ë¦¬í•´ì•¼ ì•ˆì •ì ì¸ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥.
* **ë§í¬**: [amazon.com â€“ ì±… ì†Œê°œ](https://www.amazon.com/Growing-Object-Oriented-Software-Guided-Tests/dp/0321503627)

---

### 3. Eric Evans: *Domain-Driven Design*

* **ë‚´ìš©**: DDD(ë„ë©”ì¸ ì£¼ë„ ì„¤ê³„)ì˜ ê³ ì „.

  * **Anti-Corruption Layer (ACL)** ê°œë… ì œì‹œ â†’ ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ ë„ë©”ì¸ ëª¨ë¸ ì‚¬ì´ì— ë³´í˜¸ ê³„ì¸µì„ ë‘¬ì„œ ì™¸ë¶€ ì˜í–¥ ìµœì†Œí™”.
  * ì„œë“œíŒŒí‹° ì‹œìŠ¤í…œì´ë‚˜ ë ˆê±°ì‹œ ì½”ë“œì™€ì˜ ê²°í•©ë„ë¥¼ ë‚®ì¶”ëŠ” í•µì‹¬ íŒ¨í„´.
* **ë§í¬**: [Microsoft Docs â€“ Anti-Corruption Layer íŒ¨í„´](https://learn.microsoft.com/en-us/azure/architecture/patterns/anti-corruption-layer)

