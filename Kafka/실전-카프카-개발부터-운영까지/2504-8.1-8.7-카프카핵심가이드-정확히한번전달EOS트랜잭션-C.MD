# ğŸ“˜ ì œ8ì¥ â€” ì •í™•íˆ í•œ ë²ˆ ì „ë‹¬ (Exactly Once Semantics, EOS)

---

## ğŸ§© 8.1 ë©”ì‹œì§€ ì „ì†¡ ë³´ì¥ (Delivery Semantics)

| ìœ í˜•                | ì„¤ëª…                   | ë¬¸ì œì             |
| ----------------- | -------------------- | -------------- |
| **At most once**  | ìµœëŒ€ í•œ ë²ˆ â€” ì¤‘ë³µ X, ìœ ì‹¤ ê°€ëŠ¥ | ì‹ ë¢°ì„± ë‚®ìŒ         |
| **At least once** | ìµœì†Œ í•œ ë²ˆ â€” ìœ ì‹¤ X, ì¤‘ë³µ ê°€ëŠ¥ | ëŒ€ë¶€ë¶„ ê¸°ë³¸ê°’        |
| **Exactly once**  | ì •í™•íˆ í•œ ë²ˆ              | êµ¬í˜„ ë³µì¡, ì¹´í”„ì¹´ê°€ í•´ê²° |

KafkaëŠ” 0.11 ë²„ì „ë¶€í„° **í”„ë¡œë“€ì„œÂ·ì»¨ìŠˆë¨¸Â·ë¸Œë¡œì»¤ ìˆ˜ì¤€ì˜ ì¡°í•©**ìœ¼ë¡œ EOSë¥¼ ë³´ì¥í•¨.

---

## âš™ï¸ 8.2 ì¤‘ë³µ ë¬¸ì œì˜ ì›ì¸

### ğŸ“ 1. í”„ë¡œë“€ì„œ ì¬ì‹œë„

* ì „ì†¡ ë„ì¤‘ ACK ë¯¸ìˆ˜ì‹  â†’ ì¬ì „ì†¡ ë°œìƒ
* ë¸Œë¡œì»¤ëŠ” ë™ì¼ ë©”ì‹œì§€ë¥¼ ë‹¤ì‹œ ìˆ˜ì‹  â†’ ì¤‘ë³µ ê¸°ë¡ ê°€ëŠ¥

### ğŸ“ 2. ì»¨ìŠˆë¨¸ ì¬ì²˜ë¦¬

* ì˜¤í”„ì…‹ ì»¤ë°‹ ì „ì— ì¥ì•  ë°œìƒ â†’ ë™ì¼ ë°ì´í„° ì¬ì²˜ë¦¬

---

### ğŸ§  í•´ê²° ì›ë¦¬

1. **í”„ë¡œë“€ì„œ ë©±ë“±ì„± (Idempotence)**
2. **íŠ¸ëœì­ì…˜ í”„ë¡œë“€ì„œ + ì»¨ìŠˆë¨¸**
3. **ì½ê³  ì“°ê¸°(Read-Process-Write) ì‹œ íŠ¸ëœì­ì…˜ ìœ ì§€**

---

## ğŸ” 8.3 í”„ë¡œë“€ì„œ ë©±ë“±ì„± (Idempotent Producer)

### ğŸ“ ê°œë…

> ë™ì¼ ë©”ì‹œì§€ë¥¼ ì—¬ëŸ¬ ë²ˆ ì „ì†¡í•´ë„ ë¸Œë¡œì»¤ëŠ” ë‹¨ í•œ ë²ˆë§Œ ê¸°ë¡.

### ğŸ’¡ ë™ì‘ ë°©ì‹

* ê° í”„ë¡œë“€ì„œ ì¸ìŠ¤í„´ìŠ¤ëŠ” `PID`(Producer ID)ë¥¼ ê°€ì§.
* ê° íŒŒí‹°ì…˜ë³„ë¡œ `sequence number`ë¥¼ ê´€ë¦¬.
* ë¸Œë¡œì»¤ëŠ” (PID, Partition, SeqNo) ì¡°í•©ìœ¼ë¡œ ì¤‘ë³µ ê°ì§€.

| ì„¤ì •                                      | ê°’      | ì„¤ëª…      |
| --------------------------------------- | ------ | ------- |
| `enable.idempotence`                    | `true` | ë©±ë“±ì„± í™œì„±í™” |
| `acks`                                  | `all`  | í•„ìˆ˜ ì¡°í•©   |
| `max.in.flight.requests.per.connection` | â‰¤ 5    | ìˆœì„œ ë³´ì¥   |

> âš ï¸ PIDëŠ” í”„ë¡œë“€ì„œ ì¬ì‹œì‘ ì‹œ ë³€ê²½ë¨ â†’ ì¬ì‹œì‘ ê°„ì—ëŠ” EOS ë¶ˆê°€.
> íŠ¸ëœì­ì…˜ APIë¡œë§Œ ì„¸ì…˜ì„ ì´ì–´ê°ˆ ìˆ˜ ìˆìŒ.

---

### ğŸš€ ì˜ˆì œ (Kotlin)

```kotlin
val props = Properties().apply {
    put("bootstrap.servers", "localhost:9092")
    put("enable.idempotence", "true")
    put("acks", "all")
    put("max.in.flight.requests.per.connection", "5")
    put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer")
    put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer")
}
val producer = KafkaProducer<String, String>(props)
producer.send(ProducerRecord("payments", "order-001", "paid"))
```

> ğŸ’¬ **ê²°ê³¼:** ë™ì¼ ë©”ì‹œì§€ ì „ì†¡ ì‹œì—ë„ KafkaëŠ” ì¤‘ë³µ ê¸°ë¡í•˜ì§€ ì•ŠìŒ.

---

## ğŸ§® 8.4 íŠ¸ëœì­ì…˜ í”„ë¡œë“€ì„œ (Transactional Producer)

KafkaëŠ” ë‹¨ì¼ í”„ë¡œë“€ì„œ ì„¸ì…˜ ë‚´ì—ì„œ ì—¬ëŸ¬ í† í”½Â·íŒŒí‹°ì…˜ì— ê±¸ì¹œ ë©”ì‹œì§€ë¥¼
**íŠ¸ëœì­ì…˜ ë‹¨ìœ„ë¡œ ì›ìì (atomic)ìœ¼ë¡œ ê¸°ë¡** ê°€ëŠ¥.

---

### âš™ï¸ ì„¤ì •

| ì„¤ì •                       | ì„¤ëª…                    |
| ------------------------ | --------------------- |
| `transactional.id`       | íŠ¸ëœì­ì…˜ ì‹ë³„ì (í”„ë¡œë“€ì„œ ì„¸ì…˜ ê³ ìœ ) |
| `enable.idempotence`     | ìë™ í™œì„±í™”ë¨               |
| `acks=all`               | í•„ìˆ˜                    |
| `transaction.timeout.ms` | íŠ¸ëœì­ì…˜ ë§Œë£Œì‹œê°„ (ê¸°ë³¸ 1ë¶„)     |

---

### ğŸ”„ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ íë¦„

```mermaid
sequenceDiagram
participant P as Producer
participant B as Broker
P->>B: initTransactions()
P->>B: beginTransaction()
P->>B: send() ì—¬ëŸ¬ ë²ˆ
P->>B: commitTransaction() or abortTransaction()
```

* `commitTransaction()` â†’ ëª¨ë“  ë©”ì‹œì§€ ì›ìì  ì»¤ë°‹
* `abortTransaction()` â†’ ì „ì²´ ë¡¤ë°±

---

### ğŸš€ ì˜ˆì œ (Kotlin)

```kotlin
val props = Properties().apply {
    put("bootstrap.servers", "localhost:9092")
    put("transactional.id", "payment-tx-1")
    put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer")
    put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer")
}
val producer = KafkaProducer<String, String>(props)
producer.initTransactions()

try {
    producer.beginTransaction()
    producer.send(ProducerRecord("orders", "order-001", "confirmed"))
    producer.send(ProducerRecord("payments", "order-001", "paid"))
    producer.commitTransaction()
} catch (e: Exception) {
    producer.abortTransaction()
}
```

> ğŸ’¬ **ê²°ê³¼:** ë‘ í† í”½ ëª¨ë‘ ì„±ê³µ ë˜ëŠ” ë‘˜ ë‹¤ ì‹¤íŒ¨ (ì›ìì„± ë³´ì¥)

---

## ğŸ”„ 8.5 íŠ¸ëœì­ì…˜ ì»¨ìŠˆë¨¸ (Transactional Consumer)

### ğŸ“ ê°œë…

> íŠ¸ëœì­ì…˜ í”„ë¡œë“€ì„œê°€ ë³´ë‚¸ ë©”ì‹œì§€ ì¤‘ â€œì»¤ë°‹ëœ ê²ƒë§Œâ€ ì½ë„ë¡ ë³´ì¥.

| ì„¤ì •                | ì„¤ëª…                                    |
| ----------------- | ------------------------------------- |
| `isolation.level` | `read_committed` / `read_uncommitted` |
| ê¸°ë³¸ê°’               | `read_uncommitted` (ëª¨ë“  ë©”ì‹œì§€ ì½ìŒ)        |

> ğŸ’¡ `read_committed` ë¡œ ì„¤ì • ì‹œ:
>
> * `commitTransaction()` ëœ ë©”ì‹œì§€ë§Œ ì½ìŒ
> * `abortTransaction()` ëœ ë©”ì‹œì§€ëŠ” ë¬´ì‹œ

---

### ğŸš€ ì˜ˆì œ

```kotlin
val props = Properties().apply {
    put("bootstrap.servers", "localhost:9092")
    put("group.id", "payment-processor")
    put("isolation.level", "read_committed")
    put("key.deserializer", "org.apache.kafka.common.serialization.StringDeserializer")
    put("value.deserializer", "org.apache.kafka.common.serialization.StringDeserializer")
}
val consumer = KafkaConsumer<String, String>(props)
consumer.subscribe(listOf("payments"))
```

---

## ğŸ” 8.6 ì½ê³  ì“°ê¸° íŠ¸ëœì­ì…˜ (Consume â†’ Process â†’ Produce)

KafkaëŠ” â€œì»¨ìŠˆë¨¸ + í”„ë¡œë“€ì„œâ€ì˜ íŠ¸ëœì­ì…˜ ê²°í•©ìœ¼ë¡œ
**Exactly Once Processing (EOP)**ì„ ì™„ì„±í•¨.

---

### ğŸ”„ í”„ë¡œì„¸ìŠ¤ íë¦„

```mermaid
sequenceDiagram
Consumer->>App: poll()
App->>App: ì²˜ë¦¬ ë¡œì§ ì‹¤í–‰
App->>Producer: send()
Producer->>Broker: commitTransaction() (+ ì»¨ìŠˆë¨¸ ì˜¤í”„ì…‹ í¬í•¨)
```

> ì»¨ìŠˆë¨¸ ì˜¤í”„ì…‹ ì»¤ë°‹ë„ íŠ¸ëœì­ì…˜ ë‚´ì— í¬í•¨ ê°€ëŠ¥!
> â†’ **â€œì´ ë©”ì‹œì§€ëŠ” ì²˜ë¦¬ ì™„ë£Œâ€ê°€ ì™„ë²½íˆ ì¼ê´€ì„± ìˆê²Œ ë°˜ì˜**

---

### ğŸš€ ì˜ˆì œ (Kotlin)

```kotlin
producer.initTransactions()
while (true) {
    val records = consumer.poll(Duration.ofMillis(100))
    producer.beginTransaction()
    for (record in records) {
        val output = process(record.value()) // ê°€ê³µ ë¡œì§
        producer.send(ProducerRecord("processed", record.key(), output))
    }
    producer.sendOffsetsToTransaction(
        consumer.assignment().associateWith { tp ->
            OffsetAndMetadata(consumer.position(tp))
        },
        consumer.groupMetadata()
    )
    producer.commitTransaction()
}
```

> ğŸ’¬ **ê²°ê³¼:**
>
> * ë©”ì‹œì§€ ì¤‘ë³µ, ìœ ì‹¤ ì—†ì´ ì²˜ë¦¬
> * ì»¨ìŠˆë¨¸ ì˜¤í”„ì…‹ë„ ì¼ê´€ë˜ê²Œ ì»¤ë°‹

---

## ğŸ” 8.7 ì œì•½ì‚¬í•­ ë° íŠ¸ë ˆì´ë“œì˜¤í”„

| í•­ëª©         | ì„¤ëª…                                     |
| ---------- | -------------------------------------- |
| íŠ¸ëœì­ì…˜ ìœ ì§€ ì‹œê°„ | `transaction.timeout.ms` ì´ˆê³¼ ì‹œ ìë™ abort |
| ì„±ëŠ¥         | ì¶”ê°€ ë¡œê·¸ ê¸°ë¡ â†’ ì§€ì—° ì•½ê°„ ì¦ê°€                    |
| í˜¸í™˜ì„±        | Kafka 0.11 ì´ìƒ í•„ìš”                       |
| ìš´ì˜ ë‚œì´ë„     | transactional.id ì¶©ëŒ, timeout ê´€ë¦¬ í•„ìš”     |

> ğŸ’¡ íŠ¸ëœì­ì…˜ì€ â€œëª¨ë“  ë¬¸ì œì˜ í•´ë‹µâ€ì´ ì•„ë‹˜ â€”
> ëŒ€ë¶€ë¶„ì˜ íŒŒì´í”„ë¼ì¸ì€ ë©±ë“±ì„± + ì¬ì‹œë„ ë¡œì§ë§Œìœ¼ë¡œ ì¶©ë¶„í•¨.

---

## ğŸ§­ ì „ì²´ ìš”ì•½í‘œ

| ì„¹ì…˜      | í•µì‹¬ ì£¼ì œ                | ìš”ì•½                         |
| ------- | -------------------- | -------------------------- |
| **8.1** | ì „ë‹¬ ë³´ì¥ ëª¨ë¸             | at most/least/exactly once |
| **8.2** | ì¤‘ë³µ ì›ì¸                | ì¬ì‹œë„, ì»¤ë°‹ ìˆœì„œ ë¬¸ì œ              |
| **8.3** | ë©±ë“±ì„± í”„ë¡œë“€ì„œ             | PID + SeqNoë¡œ ì¤‘ë³µ ì œê±°         |
| **8.4** | íŠ¸ëœì­ì…˜ í”„ë¡œë“€ì„œ            | ì›ìì  commit/abort ì§€ì›        |
| **8.5** | íŠ¸ëœì­ì…˜ ì»¨ìŠˆë¨¸             | read_committedë¡œ í•„í„°ë§        |
| **8.6** | Consume-Produce íŠ¸ëœì­ì…˜ | ì™„ì „í•œ Exactly Once ì²˜ë¦¬        |
| **8.7** | ì œì•½ì‚¬í•­                 | ì„±ëŠ¥Â·ìš´ì˜ ë³µì¡ì„± ê³ ë ¤ í•„ìš”            |

---

## ğŸ’¡ ë‚´ ìƒê° (ChatGPT ì²¨ì–¸)

> Kafkaì˜ EOSëŠ” DB íŠ¸ëœì­ì…˜ê³¼ ë‹¬ë¦¬ â€œë¶„ì‚° ìŠ¤íŠ¸ë¦¼ì—ì„œì˜ ì›ìì„± ë³´ì¥â€ì´ë¼ëŠ” ì ì´ í•µì‹¬ì…ë‹ˆë‹¤.
> ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” **idempotent + retries + DLQ + offset commit**ìœ¼ë¡œ ì¶©ë¶„í•œ ê²½ìš°ê°€ ë§ê³ ,
> EOSëŠ” **ì •í™•íˆ í•œ ë²ˆë§Œ í•„ìš”í•œ ê³ ê°€ìš© ë°ì´í„° íŒŒì´í”„ë¼ì¸(ê²°ì œ, ë¡œê·¸ ì§‘ê³„ ë“±)** ì—ì„œë§Œ í™œì„±í™”í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

---

## ğŸ“š ì°¸ê³  ë§í¬

* [KIP-98: Exactly Once Semantics](https://cwiki.apache.org/confluence/display/KAFKA/KIP-98)
* [Confluent Blog: Transactions in Apache Kafka](https://www.confluent.io/blog/transactions-apache-kafka/)
* [Kafka Docs: Transactions and Idempotence](https://kafka.apache.org/documentation/#producerconfigs_enable.idempotence)

