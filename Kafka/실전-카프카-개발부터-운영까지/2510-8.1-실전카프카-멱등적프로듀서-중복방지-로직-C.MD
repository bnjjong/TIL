# ğŸ§© 8ì¥ â€“ ì •í™•íˆ í•œ ë²ˆ ì˜ë¯¸ êµ¬ì¡° (Exactly Once Semantics)

## 8.1 ë©±ë“±ì  í”„ë¡œë“€ì„œ (Idempotent Producer)

### 8.1.1 ê°œë… ë° ë°°ê²½

* **ë©±ë“±ì„±(Idempotence)**:
  ë™ì¼í•œ ì‘ì—…ì„ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•´ë„ ê²°ê³¼ê°€ ë³€í•˜ì§€ ì•ŠëŠ” ì„±ì§ˆ.
  ì˜ˆ)

    * `UPDATE t SET X = X + 1 WHERE Y = 5` â†’ ë©±ë“± ì•„ë‹˜
    * `UPDATE t SET X = 18 WHERE Y = 5` â†’ ë©±ë“±

* **Kafkaì—ì„œì˜ í•„ìš”ì„±**:
  ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, ë¸Œë¡œì»¤ ì¥ì• , íƒ€ì„ì•„ì›ƒ ë“±ìœ¼ë¡œ í”„ë¡œë“€ì„œê°€ ë™ì¼ ë©”ì‹œì§€ë¥¼ ì¬ì „ì†¡í•  ìˆ˜ ìˆë‹¤.
  ì´ë•Œ ë©±ë“±ì„±ì´ ì—†ìœ¼ë©´ **ì¤‘ë³µ ë©”ì‹œì§€**ê°€ ì €ì¥ë  ìœ„í—˜ì´ ìˆìŒ â†’ ì¬ê³ , ê²°ì œ, ë°°ì†¡ ë“±ì˜ ë„ë©”ì¸ì—ì„œëŠ” ì¹˜ëª…ì  ì˜¤ë¥˜.

---

### 8.1.2 ì‘ë™ ì›ë¦¬

KafkaëŠ” **í”„ë¡œë“€ì„œ ID(PID)** ì™€ **ì‹œí€€ìŠ¤ ë„˜ë²„(sequence ID)** ë¥¼ ì¡°í•©í•´ ê° ë©”ì‹œì§€ë¥¼ ê³ ìœ í•˜ê²Œ ì‹ë³„í•œë‹¤.

| êµ¬ì„±ìš”ì†Œ                         | ì„¤ëª…                      |
| ---------------------------- | ----------------------- |
| Producer ID (PID)            | í”„ë¡œë“€ì„œê°€ ë¸Œë¡œì»¤ë¡œë¶€í„° ë¶€ì—¬ë°›ëŠ” ê³ ìœ  ID |
| Sequence Number              | íŒŒí‹°ì…˜ë³„ ë©”ì‹œì§€ì˜ ìˆœì°¨ ë²ˆí˜¸         |
| (PID + Partition + Sequence) | ë©”ì‹œì§€ ê³ ìœ  ì‹ë³„ì              |

* ë¸Œë¡œì»¤ëŠ” ê° íŒŒí‹°ì…˜ì— ëŒ€í•´ **ìµœê·¼ 5ê°œì˜ ì‹œí€€ìŠ¤ ë„˜ë²„**ë¥¼ ì¶”ì í•¨.
* ì¤‘ë³µ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ë¸Œë¡œì»¤ëŠ” **ì—ëŸ¬ë¥¼ ë°œìƒì‹œì¼œ ë©”ì‹œì§€ë¥¼ ê±°ë¶€**.
* `max.in.flight.requests.per.connection` â‰¤ 5 (ê¸°ë³¸ê°’ 5)ë¡œ ìœ ì§€í•´ì•¼ í•¨.
    * í•˜ë‚˜ì˜ ì—°ê²°(Connection) ë‹¹ ë¸Œë¡œì»¤ë¡œ ë™ì‹œì— ë³´ë‚¼ ìˆ˜ ìˆëŠ” ìš”ì²­(request)ì˜ ê°œìˆ˜
    * ë‚˜ë¦„ 5ë¼ëŠ” ê¸°ë³¸ê°’ì„ ì‹¬ë„ìˆê²Œ ê³ ë¯¼í•˜ì—¬ ê²°ì •í•¨.
    * 6ì´ ë˜ëŠ” ìˆœê°„ ì•„ë˜ì™€ ê°™ì€ ìƒí™©ì´ ë°œìƒí• ìˆ˜ë„ ìˆë‹¤.
        * ìš”ì²­1(seq=1), ìš”ì²­2(seq=2), ..., ìš”ì²­6(seq=6)
        * ë„ì°© ìˆœì„œ: 4 â†’ 5 â†’ 6 â†’ 1 â†’ 2 â†’ 3
        * ë¸Œë¡œì»¤ [4,5,6,7,8] ê¸°ì–µ
        * 1ë²ˆ ë„ì°©ì‹œ ë¸Œë¡œì»¤ ë©”ëª¨ë¦¬ì— ì—†ìœ¼ë¯€ë¡œ ìƒˆë¡œìš´ ë©”ì‹œì§€ì¸ì§€ ì¤‘ë³µì¸ì§€ íŒë‹¨ ë¶ˆê°€ê°€ ë ìˆ˜ ìˆìŒ.

---

### 8.1.3 ì¥ì•  ìƒí™© ì²˜ë¦¬

#### â‘  í”„ë¡œë“€ì„œ ì¥ì• 

* ì¬ì‹œì‘ ì‹œ **ìƒˆë¡œìš´ PID**ë¥¼ ë¶€ì—¬ë°›ìŒ.
* ë”°ë¼ì„œ, ì´ì „ í”„ë¡œë“€ì„œì™€ ìƒˆë¡œìš´ í”„ë¡œë“€ì„œê°€ ë™ì¼ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•´ë„ KafkaëŠ” ì´ë¥¼ **ì¤‘ë³µìœ¼ë¡œ ì¸ì‹í•˜ì§€ ëª»í•¨**.
* ì¦‰, **í”„ë¡œë“€ì„œ ì¬ì‹œì‘ í›„ ë©±ë“±ì„±ì€ ìœ ì§€ë˜ì§€ ì•ŠìŒ**.

#### â‘¡ ë¸Œë¡œì»¤ ì¥ì• 

* ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ìƒˆ ë¦¬ë” ì„ ì¶œ â†’ íŒ”ë¡œì›Œê°€ ë¦¬ë”ê°€ ë˜ë©´ ì¸ë©”ëª¨ë¦¬ ìƒíƒœ(ìµœê·¼ 5ê°œ ì‹œí€€ìŠ¤ ë²ˆí˜¸)ë¥¼ ë³µì œí•˜ì—¬ ìœ ì§€.
* ì¥ì•  ë¸Œë¡œì»¤ ë³µêµ¬ ì‹œ ìŠ¤ëƒ…ìƒ· íŒŒì¼ì„ í†µí•´ **Producer ìƒíƒœë¥¼ ë³µì›**.

> ë§Œì•½ ë©”ì‹œì§€ê°€ ì „í˜€ ì—†ëŠ” íŒŒí‹°ì…˜ì´ë¼ë©´?
> ì¤‘ë³µì´ ì—†ìœ¼ë¯€ë¡œ ë°”ë¡œ ìƒˆ ìƒíƒœë¥¼ ìƒì„± ê°€ëŠ¥.

---

### 8.1.4 í•œê³„ì 

| êµ¬ë¶„         | ì„¤ëª…                            |
| ---------- | ----------------------------- |
| í”„ë¡œë“€ì„œ ì¬ì‹œì‘   | ìƒˆ PIDë¡œ ì¸í•´ ì´ì „ ë©”ì‹œì§€ ì¤‘ë³µ ê°ì§€ ë¶ˆê°€     |
| ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤    | ì—¬ëŸ¬ í”„ë¡œë“€ì„œê°€ ë™ì¼ ë©”ì‹œì§€ ì „ì†¡ ì‹œ ì¤‘ë³µ ê°ì§€ ë¶ˆê°€ |
| ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œë„ | ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì§ì ‘ ì¬ì‹œë„ ì‹œ ì¤‘ë³µ ë°œìƒ ê°€ëŠ¥    |

ğŸ‘‰ **í”„ë¡œë“€ì„œ ë‚´ë¶€ì˜ ì¬ì‹œë„ ë¡œì§**ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•¨ (`retries` ì˜µì…˜ í™œìš©).

---

### 8.1.5 ì„¤ì • ë°©ë²•

* ì„¤ì • í•­ëª©:

  ```properties
  enable.idempotence=true
  acks=all
  ```

  â€» Kafka 3.0 ì´í›„ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `true`.

* ì¶”ê°€ ë™ì‘ ë³€í™”:

    * í”„ë¡œë“€ì„œ ì´ˆê¸°í™” ì‹œ PID ìš”ì²­ API ì¶”ê°€ í˜¸ì¶œ
    * ê° ë©”ì‹œì§€ ë°°ì¹˜ì— PID + Sequence ë²ˆí˜¸ í¬í•¨ (96bit ì˜¤ë²„í—¤ë“œ)
    * ì¥ì•  ì‹œì—ë„ ìˆœì„œ ë³´ì¥ (`max.in.flight.requests.per.connection â‰¤ 5`)

---

### 8.1.6 ê°œì„  ì‚¬í•­ (Kafka 2.5 ì´í›„)

* **KIP-360**: UNKNOWN_PRODUCER_ID ì˜¤ë¥˜ ëŒ€í­ ê°ì†Œ.
* ì‹œí€€ìŠ¤ ë„˜ë²„ ìœ ì§€ ê°•í™”, íŒŒí‹°ì…˜ ì¬í• ë‹¹ ì‹œ ì•ˆì •ì„± í–¥ìƒ.
* **ì¹˜ëª…ì  ì—ëŸ¬ ì‹œ ì „ì²´ ë°°ì¹˜ ê±°ë¶€ â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì²˜ë¦¬ ê²°ì • ê°€ëŠ¥**.

---

## âœ… ìš”ì•½

| í•­ëª©    | ë‚´ìš©                                    |
| ----- | ------------------------------------- |
| í•µì‹¬ ëª©ì  | ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€ (Exactly-Once ì „ ë‹¨ê³„)         |
| ì£¼ìš” êµ¬ì„± | PID + Sequence Number                 |
| í•„ìš” ì„¤ì • | `enable.idempotence=true`, `acks=all` |
| í•œê³„    | ì¬ì‹œì‘ ì‹œ PID ë³€ê²½ â†’ ì¤‘ë³µ ê°ì§€ ë¶ˆê°€               |
| ê¶Œì¥    | í”„ë¡œë“€ì„œ ë‚´ë¶€ ì¬ì‹œë„ ì‚¬ìš©, ì„¤ì • ì•ˆì •í™” í™•ì¸             |
| ê°œì„     | Kafka 2.5 ì´í›„ ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”                 |

---

## ğŸ’¡ GPT ì½”ë©˜íŠ¸

> ë©±ë“±ì„±ì€ ë‹¨ìˆœíˆ â€œí•œ ë²ˆë§Œ ì²˜ë¦¬â€ì˜ ë¬¸ì œê°€ ì•„ë‹ˆë¼, **â€œë¹„ì¦ˆë‹ˆìŠ¤ ìƒíƒœì˜ ì¼ê´€ì„±â€** ì„ ì§€í‚¤ëŠ” ê¸°ìˆ ì´ì—ìš”.
> ì¦‰, **ë„ë©”ì¸ ì´ë²¤íŠ¸ë¥¼ ì¬ì²˜ë¦¬í•´ë„ ì‹œìŠ¤í…œ ìƒíƒœê°€ ë³€í•˜ì§€ ì•Šì•„ì•¼** í•©ë‹ˆë‹¤.

---

# ğŸ’» Kotlin ì˜ˆì œ (ë„ë©”ì¸ ë¡œì§ ê¸°ë°˜)

## ğŸ“ ì‹œë‚˜ë¦¬ì˜¤

* ê´‘ê³  í´ë¦­ ì´ë²¤íŠ¸(`AdClickEvent`)ê°€ Kafkaë¡œ ì „ì†¡ë¨.
* ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€ë¥¼ ìœ„í•´ **ë©±ë“±ì  í”„ë¡œë“€ì„œ ì„¤ì •**ì„ ì ìš©.

---

### ğŸ§© As-Is (ë¹„ë©±ë“±ì  í”„ë¡œë“€ì„œ)

```kotlin
// ì¤‘ë³µ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ ê°€ëŠ¥ (ê°™ì€ ì´ë²¤íŠ¸ê°€ ì—¬ëŸ¬ ë²ˆ ì „ì†¡ë  ìˆ˜ ìˆìŒ)
fun sendClickEvent(adId: String, userId: String) {
    val producer = KafkaProducer<String, String>(
        mapOf(
            "bootstrap.servers" to "localhost:9092",
            "key.serializer" to "org.apache.kafka.common.serialization.StringSerializer",
            "value.serializer" to "org.apache.kafka.common.serialization.StringSerializer"
        )
    )

    val record = ProducerRecord("ad-clicks", adId, """{"adId":"$adId","userId":"$userId"}""")
    producer.send(record)
    producer.close()
}
```

---

### âœ… To-Be (ë©±ë“±ì  í”„ë¡œë“€ì„œ ì ìš©)

```kotlin
fun sendClickEventIdempotent(adId: String, userId: String) {
    val producer = KafkaProducer<String, String>(
        mapOf(
            "bootstrap.servers" to "localhost:9092",
            "enable.idempotence" to "true",    // ë©±ë“±ì„± í™œì„±í™”
            "acks" to "all",                   // ëª¨ë“  ë¦¬ë” ë³µì œ ì™„ë£Œ í›„ ì‘ë‹µ
            "retries" to "3",                  // ë‚´ë¶€ ì¬ì‹œë„
            "max.in.flight.requests.per.connection" to "5",
            "key.serializer" to "org.apache.kafka.common.serialization.StringSerializer",
            "value.serializer" to "org.apache.kafka.common.serialization.StringSerializer"
        )
    )

    val eventJson = """{"adId":"$adId","userId":"$userId"}"""
    val record = ProducerRecord("ad-clicks", adId, eventJson)

    // ë™ì¼ ë©”ì‹œì§€ ì¬ì „ì†¡ì—ë„ Kafkaê°€ ìë™ ì¤‘ë³µ ì œê±°
    producer.send(record)
    producer.close()
}
```

---

### ğŸ§ª Kotest í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ

```kotlin
class AdClickProducerTest : StringSpec({

    "ë©±ë“±ì  í”„ë¡œë“€ì„œê°€ ë™ì¼ ë©”ì‹œì§€ë¥¼ ì¤‘ë³µ ì €ì¥í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤" {
        val adId = "AD-1234"
        val userId = "USER-99"

        sendClickEventIdempotent(adId, userId)
        sendClickEventIdempotent(adId, userId) // ì¤‘ë³µ ì‹œë„

        // ì‹¤ì œë¡œëŠ” Kafka consumer groupì—ì„œ consume í›„ ì¤‘ë³µ key ì—¬ë¶€ ê²€ì¦ ê°€ëŠ¥
        // í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ë‹¨ìˆœíˆ ì¤‘ë³µ keyê°€ ì—†ëŠ” Kafka ìƒíƒœë¼ê³  ê°€ì •
        val result = checkKafkaMessageCount(topic = "ad-clicks", key = adId)
        result shouldBe 1
    }
})
```

---

# ğŸŒ ì°¸ê³  ìë£Œ

* [Apache Kafka Official â€” Idempotent Producer Guide](https://kafka.apache.org/documentation/#producerconfigs_enable.idempotence)
* [KIP-360: Improve Idempotent and Transactional Producer](https://cwiki.apache.org/confluence/display/KAFKA/KIP-360%3A+Improve+Idempotent+and+Transactional+Producer)
* [KIP-679: Producer Strongest Delivery Guarantee by Default](https://cwiki.apache.org/confluence/display/KAFKA/KIP-679%3A+Producer+will+enable+the+strongest+delivery+guarantee+by+default)

---
