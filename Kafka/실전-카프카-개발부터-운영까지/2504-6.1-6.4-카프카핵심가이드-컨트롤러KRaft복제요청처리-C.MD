# ğŸ“˜ ì œ6ì¥: ì¹´í”„ì¹´ ë‚´ë¶€ ë©”ì»¤ë‹ˆì¦˜

> ì´ ì¥ì€ â€œì¹´í”„ì¹´ë¥¼ ì˜ ìš´ìš©í•˜ê³  íŠœë‹í•˜ê¸° ìœ„í•´ ë‚´ë¶€ë¥¼ ì´í•´í•´ì•¼ í•˜ëŠ” ì´ìœ â€ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤.
> ì„¤ê³„ ì² í•™ë³´ë‹¤ **ë¸Œë¡œì»¤Â·ì»¨íŠ¸ë¡¤ëŸ¬Â·ë³µì œÂ·ìš”ì²­ ì²˜ë¦¬ íë¦„** ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## ğŸ§© 6.1 í´ëŸ¬ìŠ¤í„° ë©¤ë²„ì‹­

### ğŸ“ í•µì‹¬ ê°œë…

* **Zookeeper**ëŠ” ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„°ì˜ ë¸Œë¡œì»¤ ëª©ë¡ì„ ê´€ë¦¬í•¨.
* ê° ë¸Œë¡œì»¤ëŠ” ê³ ìœ í•œ `broker.id`ë¡œ ì‹ë³„ë˜ë©°, ì‹œì‘ ì‹œ `/brokers/ids` ê²½ë¡œì— **Ephemeral ë…¸ë“œ**ë¥¼ ë“±ë¡í•¨.
* ì´ ë…¸ë“œëŠ” ë¸Œë¡œì»¤ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì§€ë©´ ìë™ ì‚­ì œë˜ì–´ í´ëŸ¬ìŠ¤í„°ê°€ í•´ë‹¹ ë¸Œë¡œì»¤ì˜ â€œì´íƒˆâ€ì„ ì¸ì‹í•¨.

### âš™ï¸ ë™ì‘ íë¦„

1. ë¸Œë¡œì»¤ ì‹œì‘ â†’ Ephemeral ë…¸ë“œ ìƒì„± (`/brokers/ids/{broker.id}`)
2. ì£¼í‚¤í¼ ê°ì‹œ(watch) â†’ ë¸Œë¡œì»¤ ì¶”ê°€/ì œê±° ì•Œë¦¼
3. ë™ì¼ ID ì¶©ëŒ ì‹œ ë¸Œë¡œì»¤ ì‹œì‘ ì‹¤íŒ¨
4. ë¸Œë¡œì»¤ ì¢…ë£Œ/ë‹¨ì ˆ ì‹œ â†’ Ephemeral ë…¸ë“œ ì‚­ì œ â†’ ì»¨íŠ¸ë¡¤ëŸ¬ ê°ì§€

> ğŸ’¡ **ì¦‰:** ì£¼í‚¤í¼ëŠ” â€œí˜„ì¬ ì‚´ì•„ìˆëŠ” ë¸Œë¡œì»¤ì˜ ì§‘í•©â€ì„ ìœ ì§€í•˜ë©°,
> ì´ ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ì¹´í”„ì¹´ì˜ ë™ì  ë¦¬ë” ì„ ì¶œê³¼ ë³µêµ¬ê°€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

---

## âš™ï¸ 6.2 ì»¨íŠ¸ë¡¤ëŸ¬ (Controller)

ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” **ë¦¬ë” íŒŒí‹°ì…˜ ì„ ì¶œê³¼ ë©”íƒ€ë°ì´í„° ê´€ë¦¬**ì˜ í•µì‹¬ ì—­í• ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.

### ğŸ“ ê¸°ë³¸ ì›ë¦¬

* í´ëŸ¬ìŠ¤í„°ì—ì„œ ê°€ì¥ ë¨¼ì € `/controller` ë…¸ë“œë¥¼ ë“±ë¡í•œ ë¸Œë¡œì»¤ê°€ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ë¨.
* ì´ ë…¸ë“œ ì—­ì‹œ Ephemeralì´ë©°, ì»¨íŠ¸ë¡¤ëŸ¬ ì¢…ë£Œ/ë‹¨ì ˆ ì‹œ ë‹¤ë¥¸ ë¸Œë¡œì»¤ê°€ ìƒˆë¡œ ì„ ì¶œë¨.
* ì£¼í‚¤í¼ì˜ `epoch`(ì„¸ëŒ€ ë²ˆí˜¸)ì„ ì‚¬ìš©í•´ â€œì¢€ë¹„ ì»¨íŠ¸ë¡¤ëŸ¬â€ë¥¼ ë°©ì§€.

> ğŸ§  **ì¢€ë¹„ ì»¨íŠ¸ë¡¤ëŸ¬:**
> ê¸°ì¡´ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì¬ì—°ê²°ë˜ë©° ìì‹ ì´ ì—¬ì „íˆ ìœ íš¨í•˜ë‹¤ê³  ì°©ê°í•´ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” ë¬¸ì œ.
> í•´ê²°: ê° ë©”ì‹œì§€ì— `controllerEpoch` ê°’ì„ í¬í•¨ì‹œì¼œ ë¬´íš¨í™”.

---

### ğŸ“¦ ë¦¬ë” ì„ ì¶œ ê³¼ì •

1. ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ë¸Œë¡œì»¤ ì´íƒˆ ê°ì§€
2. ì´íƒˆí•œ ë¸Œë¡œì»¤ì˜ ë¦¬ë” íŒŒí‹°ì…˜ ì‹ë³„
3. í•´ë‹¹ íŒŒí‹°ì…˜ì˜ ë ˆí”Œë¦¬ì¹´ ëª©ë¡ì—ì„œ ë‹¤ìŒ ë¸Œë¡œì»¤ë¥¼ ë¦¬ë”ë¡œ ì§€ì •
4. `LeaderAndISR` ìš”ì²­ì„ ìƒˆ ë¦¬ë”/íŒ”ë¡œì›Œ ë¸Œë¡œì»¤ì— ì „ì†¡
5. `UpdateMetadata` ìš”ì²­ìœ¼ë¡œ ì „ì²´ í´ëŸ¬ìŠ¤í„° ë©”íƒ€ë°ì´í„° ê°±ì‹ 

---

### âš™ï¸ 6.2.1 KRaft: Raft ê¸°ë°˜ ìƒˆë¡œìš´ ì»¨íŠ¸ë¡¤ëŸ¬

#### ğŸ”¹ ë“±ì¥ ë°°ê²½

Zookeeper ê¸°ë°˜ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í•œê³„:

* ë™ê¸°/ë¹„ë™ê¸° ì²˜ë¦¬ ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ë©”íƒ€ë°ì´í„° ë¶ˆì¼ì¹˜
* ì¬ì‹œì‘ ì‹œ ëª¨ë“  ë©”íƒ€ë°ì´í„° ì¬ë¡œë“œë¡œ ì¸í•œ ì§€ì—°
* ê´€ë¦¬ ë³µì¡ì„± (Zookeeperì™€ Kafka ë‘ ì‹œìŠ¤í…œ ìš´ìš© í•„ìš”)

#### ğŸ”¹ KRaft êµ¬ì¡° ê°œìš”

| êµ¬ì„± ìš”ì†Œ                   | ì—­í•                  |
| ----------------------- | ------------------ |
| **Controller quorum**   | Raft ê¸°ë°˜ ì»¨íŠ¸ë¡¤ëŸ¬ ë…¸ë“œ ì§‘í•© |
| **Active Controller**   | ë¦¬ë” ì—­í• , ë©”íƒ€ë°ì´í„° ë¡œê·¸ ê¸°ë¡ |
| **Follower Controller** | ë¡œê·¸ ë³µì œ ë° ì¥ì•  ëŒ€ë¹„      |
| **Broker**              | ì‹¤ì œ ë°ì´í„° ì €ì¥ ë° ì„œë¹„ìŠ¤ ì²˜ë¦¬ |

* ë©”íƒ€ë°ì´í„° ë³€ê²½ì€ â€œ**ë¡œê·¸ ê¸°ë°˜ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼**â€ìœ¼ë¡œ ê´€ë¦¬ë¨.
* ëª¨ë“  ë¸Œë¡œì»¤ëŠ” `MetadataFetch` APIë¡œ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë³€ê²½ì‚¬í•­ì„ pullí•¨.

#### ğŸ”¹ ë¸Œë¦¬ì§€ ë¦´ë¦¬ìŠ¤ (Bridge Release)

| ë‹¨ê³„                 | ì„¤ëª…                          |
| ------------------ | --------------------------- |
| **Pre-KRaft**      | ê¸°ì¡´ Zookeeper ê¸°ë°˜             |
| **Bridge Release** | KRaft ì»¨íŠ¸ë¡¤ëŸ¬ + ê¸°ì¡´ ë¸Œë¡œì»¤ í˜¼ìš©      |
| **Post-KRaft**     | ì™„ì „í•œ KRaft ê¸°ë°˜ (Zookeeper ì œê±°) |

---

### ğŸ§° KRaft ì„¤ì • ìš”ì•½

| ì„¤ì • í‚¤                       | ì„¤ëª…                                |
| -------------------------- | --------------------------------- |
| `process.roles`            | controller, broker, ë˜ëŠ” ë‘˜ ë‹¤ ì§€ì •     |
| `node.id`                  | ê³ ìœ  ë…¸ë“œ ID                          |
| `controller.quorum.voters` | ì»¨íŠ¸ë¡¤ëŸ¬ ì¿¼ëŸ¼ ë…¸ë“œ ì •ì˜                     |
| `listeners`                | ì—­í• ë³„ í¬íŠ¸ ì§€ì • (ì˜ˆ: CONTROLLER://:9093) |
| `log.dirs`                 | ë¸Œë¡œì»¤/ë©”íƒ€ë°ì´í„° ë¡œê·¸ ê²½ë¡œ                   |

> ğŸ’¡ KRaft í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”:

```bash
$ bin/kafka-storage.sh random-uuid
$ bin/kafka-storage.sh format -t <CLUSTER_ID> -c config/kraft/controller.properties
```

---

## ğŸ” 6.3 ë³µì œ (Replication)

### ğŸ“ ë³µì œ êµ¬ì¡°

| ìœ í˜•           | ì„¤ëª…                  |
| ------------ | ------------------- |
| **ë¦¬ë” ë ˆí”Œë¦¬ì¹´**  | ì“°ê¸°/ì½ê¸° ìš”ì²­ì„ ì²˜ë¦¬        |
| **íŒ”ë¡œì›Œ ë ˆí”Œë¦¬ì¹´** | ë¦¬ë” ë°ì´í„°ë¥¼ ë³µì œí•˜ì—¬ ë™ê¸°í™” ìœ ì§€ |

* ë¦¬ë” ì¥ì•  ì‹œ ì¸ì‹±í¬ ë ˆí”Œë¦¬ì¹´(ISR) ì¤‘ í•˜ë‚˜ê°€ ë¦¬ë”ë¡œ ìŠ¹ê²©.
* `replica.lag.time.max.ms` ì„¤ì •ìœ¼ë¡œ ë™ê¸°í™” ì§€ì—° í—ˆìš© ì‹œê°„ ì œì–´.

---

### ğŸ§  ë¦¬ë”-íŒ”ë¡œì›Œ ë³µì œ ë¡œì§

1. íŒ”ë¡œì›ŒëŠ” ë¦¬ë”ì— Fetch ìš”ì²­ì„ ë³´ëƒ„.
2. ë¦¬ë”ëŠ” íŒ”ë¡œì›Œê°€ ìš”ì²­í•œ ì˜¤í”„ì…‹ ì´í›„ì˜ ë©”ì‹œì§€ ì „ë‹¬.
3. ë¦¬ë”ëŠ” ê° íŒ”ë¡œì›Œì˜ ë³µì œ ìƒíƒœë¥¼ ì¶”ì í•˜ì—¬ â€œISR(In-Sync Replica)â€ ì§‘í•© ìœ ì§€.
4. ISRì´ ì¼ì • ì‹œê°„(ê¸°ë³¸ 10ì´ˆ) ë’¤ì²˜ì§€ë©´ â€œOut-of-Syncâ€ë¡œ ë¶„ë¥˜ë˜ì–´ ë¦¬ë” í›„ë³´ì—ì„œ ì œì™¸.

---

### âš¡ ì„ í˜¸ ë¦¬ë” (Preferred Leader)

* í† í”½ ìƒì„± ì‹œ ìµœì´ˆ ë¦¬ë”ë¥¼ **ì„ í˜¸ ë¦¬ë”**ë¡œ ë“±ë¡.
* `auto.leader.rebalance.enable=true` ì„¤ì • ì‹œ ìë™ ê· ë“±í™” ìˆ˜í–‰.

> ğŸ’¡ ë¶€í•˜ ë¶„ì‚° ëª©ì : ëª¨ë“  íŒŒí‹°ì…˜ì´ ë¸Œë¡œì»¤ì— ê· ë“±í•˜ê²Œ ë¶„í¬ë˜ë„ë¡ í•¨.

---

## ğŸ“¡ 6.4 ìš”ì²­ ì²˜ë¦¬ (Request Handling)

ì¹´í”„ì¹´ ë¸Œë¡œì»¤ëŠ” **í”„ë¡œë“€ì„œ/ì»¨ìŠˆë¨¸ ìš”ì²­ê³¼ ë‚´ë¶€ ë³µì œ ìš”ì²­**ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.

### ğŸ“¦ ìš”ì²­ êµ¬ì¡°

| í•„ë“œ             | ì„¤ëª…           |
| -------------- | ------------ |
| API Key        | ìš”ì²­ íƒ€ì…        |
| API Version    | ìš”ì²­ ë²„ì „        |
| Correlation ID | ìš”ì²­ ì¶”ì ìš© ê³ ìœ  ID |
| Client ID      | í´ë¼ì´ì–¸íŠ¸ ì‹ë³„ì    |

---

### âš™ï¸ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸

```
[Client]
   â†“
[Acceptor Thread]
   â†“
[Network Processor Thread]
   â†“
[Request Queue]
   â†“
[IO Thread (Request Handler)]
   â†“
[Response Queue â†’ Client]
```

* ê° í¬íŠ¸ë§ˆë‹¤ **Acceptor Thread** 1ê°œ
* ìš”ì²­ì€ **Network Thread â†’ IO Thread**ë¥¼ ê±°ì³ ì²˜ë¦¬ë¨
* ì§€ì—° ì‘ë‹µ(ì˜ˆ: Consumer poll ëŒ€ê¸°)ì€ **Purgatory Queue**ì— ë³´ê´€ë¨

---

### âœ‰ï¸ ìš”ì²­ ìœ í˜•

| ìœ í˜•                  | ì„¤ëª…                              |
| ------------------- | ------------------------------- |
| **ì“°ê¸° ìš”ì²­ (Produce)** | í”„ë¡œë“€ì„œê°€ ë³´ëƒ„, acks ì„¤ì •ì— ë”°ë¼ ì‘ë‹µ íƒ€ì´ë° ë‹¤ë¦„ |
| **ì½ê¸° ìš”ì²­ (Fetch)**   | ì»¨ìŠˆë¨¸/íŒ”ë¡œì›Œê°€ ë³´ëƒ„, í•˜ì´ì›Œí„°ë§ˆí¬ê¹Œì§€ì˜ ë©”ì‹œì§€ ë°˜í™˜   |
| **ë©”íƒ€ë°ì´í„° ìš”ì²­**        | ë¸Œë¡œì»¤ í´ëŸ¬ìŠ¤í„° ë©”íƒ€ë°ì´í„° ìš”ì²­               |
| **ì–´ë“œë¯¼ ìš”ì²­**          | í† í”½ ìƒì„±/ì‚­ì œ, ACL ê´€ë¦¬ ë“±              |

---

### ğŸ§© ì“°ê¸° ìš”ì²­ (Produce)

* `acks=0`: ë¹„ë™ê¸° (ì¦‰ì‹œ ì„±ê³µ ì‘ë‹µ)
* `acks=1`: ë¦¬ë” ì €ì¥ í›„ ì‘ë‹µ
* `acks=all`: ëª¨ë“  ISR ë³µì œ ì™„ë£Œ ì‹œ ì‘ë‹µ

ë©”ì‹œì§€ëŠ” OS ìºì‹œì— ë¨¼ì € ê¸°ë¡ë˜ë©°, ì‹¤ì œ ì§€ì†ì„±ì€ **ë³µì œì— ì˜ì¡´**í•¨.

---

### ğŸ“– ì½ê¸° ìš”ì²­ (Fetch)

* ì»¨ìŠˆë¨¸ëŠ” â€œë¦¬ë” ë ˆí”Œë¦¬ì¹´â€ì—ì„œë§Œ ì½ê¸°
* **í•˜ì´ì›Œí„°ë§ˆí¬(High-Water Mark)** ì´ì „ì˜ ë©”ì‹œì§€ë§Œ ì½ê¸° ê°€ëŠ¥
* `fetch.min.bytes`, `fetch.max.wait.ms`ë¡œ ì‘ë‹µ ì¡°ê±´ ì œì–´
* `zero-copy` ì „ì†¡ì„ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ ë³µì‚¬ ìµœì†Œí™” (ê³ ì„±ëŠ¥ì˜ í•µì‹¬)

---

### ğŸ§  ì½ê¸° ì„¸ì…˜ ìºì‹œ (Fetch Session Cache)

* ë™ì¼ ì»¨ìŠˆë¨¸ì˜ ë°˜ë³µ fetch ìš”ì²­ ì‹œ ë©”íƒ€ë°ì´í„°ë¥¼ ìºì‹œí•˜ì—¬ ì˜¤ë²„í—¤ë“œ ê°ì†Œ.
* Kafka 2.3+ ë²„ì „ì—ì„œ ë„ì…ë¨.

---

### ğŸ§© ê¸°íƒ€ ë‚´ë¶€ ìš”ì²­

* `LeaderAndISR`: ìƒˆ ë¦¬ë” ì„ ì¶œ ì‹œ ë¸Œë¡œì»¤ ê°„ ì „íŒŒ
* `OffsetCommit`, `OffsetFetch`: ì»¨ìŠˆë¨¸ ì˜¤í”„ì…‹ ê´€ë¦¬ìš©
* `ApiVersions`: ë¸Œë¡œì»¤ê°€ ì§€ì›í•˜ëŠ” ìš”ì²­ ë²„ì „ ì§ˆì˜

> ğŸ’¡ **ì¤‘ìš”:** í´ë¼ì´ì–¸íŠ¸ë³´ë‹¤ ë¸Œë¡œì»¤ë¥¼ ë¨¼ì € ì—…ê·¸ë ˆì´ë“œí•´ì•¼ ë²„ì „ í˜¸í™˜ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

## ğŸ§­ ì „ì²´ ìš”ì•½

| ì„¹ì…˜        | ì£¼ìš” ì£¼ì œ    | í•µì‹¬ í¬ì¸íŠ¸                     |
| --------- | -------- | -------------------------- |
| **6.1**   | í´ëŸ¬ìŠ¤í„° ë©¤ë²„ì‹­ | Zookeeperë¡œ ë¸Œë¡œì»¤ ìƒíƒœ ì¶”ì        |
| **6.2**   | ì»¨íŠ¸ë¡¤ëŸ¬     | ë¦¬ë” ì„ ì¶œ + ë©”íƒ€ë°ì´í„° ê´€ë¦¬           |
| **6.2.1** | KRaft    | Zookeeper ì—†ëŠ” Raft ê¸°ë°˜ ì»¨íŠ¸ë¡¤ëŸ¬  |
| **6.3**   | ë³µì œ       | ISR ìœ ì§€, ì„ í˜¸ ë¦¬ë” ë¦¬ë°¸ëŸ°ìŠ¤         |
| **6.4**   | ìš”ì²­ ì²˜ë¦¬    | Producer/Consumer ìš”ì²­ íŒŒì´í”„ë¼ì¸ |

---

## ğŸ’» Kotlin ì˜ˆì œ â€” ë¦¬ë” ì¥ì•  ê°ì§€ ë° ì•ˆì „ ë³µêµ¬

### ğŸ§© As-Is (ë‹¨ìˆœ ë¸Œë¡œì»¤ ìƒíƒœ ì²´í¬)

```kotlin
fun checkBrokerStatus(brokerList: List<Broker>) {
    brokerList.forEach {
        if (!it.isConnected()) {
            println("Broker ${it.id} is offline!")
        }
    }
}
```

---

### ğŸš€ To-Be (KRaft ê¸°ë°˜ ì¥ì•  ê°ì§€ ë° ë¦¬ë” ì¬ì„ ì¶œ)

```kotlin
data class Broker(val id: Int, var status: BrokerStatus)
enum class BrokerStatus { ONLINE, OFFLINE }

class Controller {
    private val metadata = mutableMapOf<String, Int>() // topic â†’ leader brokerId

    fun onBrokerFailure(brokerId: Int) {
        println("Broker $brokerId is down. Reassigning leaders...")
        metadata.filterValues { it == brokerId }.keys.forEach { topic ->
            val newLeader = electNewLeader(topic)
            metadata[topic] = newLeader
            println("New leader for $topic: $newLeader")
        }
    }

    private fun electNewLeader(topic: String): Int {
        // ì‹¤ì œ Kafkaì—ì„œëŠ” ISR ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì§€ë§Œ, ì—¬ê¸°ì„  ëœë¤ ì˜ˆì‹œ
        return (1..3).filter { it != metadata[topic] }.random()
    }
}

fun main() {
    val controller = Controller()
    controller.onBrokerFailure(1)
}
```

---

### ğŸ§ª Kotest ì˜ˆì‹œ

```kotlin
class ControllerTest : StringSpec({
    "should reassign leader when broker fails" {
        val controller = Controller()
        controller.onBrokerFailure(1)
    }
})
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

* [KIP-500: Replace ZooKeeper with a Self-Managed Metadata Quorum](https://cwiki.apache.org/confluence/display/KAFKA/KIP-500)
* [KIP-595: A Raft Protocol for the Metadata Quorum](https://cwiki.apache.org/confluence/display/KAFKA/KIP-595)
* [Confluent Blog - Kafka Replication Explained](https://www.confluent.io/blog/replication-in-apache-kafka/)